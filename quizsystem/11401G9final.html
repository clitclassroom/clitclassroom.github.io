<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>核心代碼：資訊獵手 | Core Code: Info Hunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Firebase Configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Auth & Leaderboard Logic
            window.initFirebase = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };

            window.saveScore = async (playerData) => {
                if (!auth.currentUser) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                        ...playerData,
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding score: ", e);
                }
            };

            window.subscribeLeaderboard = (callback) => {
                if (!auth.currentUser) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard')); 
                
                return onSnapshot(q, (snapshot) => {
                    const scores = [];
                    snapshot.forEach((doc) => {
                        scores.push(doc.data());
                    });
                    // Client-side sort because compound indexes might not be set up
                    scores.sort((a, b) => b.score - a.score || b.accuracy - a.accuracy);
                    callback(scores.slice(0, 10));
                }, (error) => {
                    console.error("Leaderboard error:", error);
                });
            };

            window.initFirebase();
        } else {
            console.warn("Firebase config not found. Leaderboard disabled.");
            window.saveScore = () => {};
            window.subscribeLeaderboard = () => {};
        }
    </script>

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #0aff00;
            --neon-yellow: #fcee0a;
            --bg-dark: #050505;
            --glass: rgba(20, 20, 20, 0.8);
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            cursor: crosshair;
            user-select: none;
        }

        .font-cyber {
            font-family: 'Orbitron', sans-serif;
        }

        /* Neon Text Effects */
        .text-neon-blue {
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
        }
        .text-neon-pink {
            color: var(--neon-pink);
            text-shadow: 0 0 5px var(--neon-pink), 0 0 10px var(--neon-pink);
        }
        .text-neon-green {
            color: var(--neon-green);
            text-shadow: 0 0 5px var(--neon-green), 0 0 10px var(--neon-green);
        }
        .text-neon-yellow {
            color: var(--neon-yellow);
            text-shadow: 0 0 5px var(--neon-yellow);
        }

        /* Cyberpunk Box */
        .cyber-box {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue), inset 0 0 20px rgba(0, 243, 255, 0.2);
            position: relative;
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 20px), 
                calc(100% - 20px) 100%, 
                0 100%
            );
        }

        .cyber-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 10px; height: 10px;
            border-top: 2px solid white;
            border-left: 2px solid white;
        }

        .cyber-box.pink {
            border-color: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink), inset 0 0 20px rgba(255, 0, 255, 0.2);
        }
        
        .cyber-box.green {
            border-color: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green), inset 0 0 20px rgba(10, 255, 0, 0.2);
        }

        /* Buttons */
        .cyber-btn {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 2px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .cyber-btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 20px var(--neon-blue);
        }
        
        .cyber-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* Input Fields */
        .cyber-input {
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
        }
        .cyber-input:focus {
            outline: none;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        /* Game Canvas */
        #gameCanvas {
            border: 2px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            background-color: #0a0a0a;
            /* Grid background pattern */
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        /* Glitch Effect Text */
        .glitch {
            position: relative;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        .glitch::before {
            left: 2px; text-shadow: -1px 0 red; clip: rect(24px, 550px, 90px, 0); animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px; text-shadow: -1px 0 blue; clip: rect(85px, 550px, 140px, 0); animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip: rect(11px, 9999px, 81px, 0); }
            20% { clip: rect(78px, 9999px, 16px, 0); }
            40% { clip: rect(14px, 9999px, 66px, 0); }
            60% { clip: rect(32px, 9999px, 73px, 0); }
            80% { clip: rect(55px, 9999px, 13px, 0); }
            100% { clip: rect(48px, 9999px, 54px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip: rect(65px, 9999px, 100px, 0); }
            20% { clip: rect(2px, 9999px, 86px, 0); }
            40% { clip: rect(44px, 9999px, 12px, 0); }
            60% { clip: rect(20px, 9999px, 48px, 0); }
            80% { clip: rect(9px, 9999px, 33px, 0); }
            100% { clip: rect(58px, 9999px, 66px, 0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-pink); }
        
        .rainbow-snake {
            animation: rainbow 0.5s linear infinite;
        }
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .answer-option {
            transition: all 0.2s;
        }
        .answer-option:hover {
            transform: scale(1.02);
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--neon-yellow);
            box-shadow: 0 0 15px var(--neon-yellow);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center">

    <!-- Raw Data for Parsing -->
    <script>
        const RAW_PDF_TEXT = `
1. ()關於電腦中資料儲存單位的敘述,下列何者錯誤? (A)最小的儲存單位為「位元組(byte)」 (B)1 byte=8 bits (C)1 GB=1024MB (D)常見的儲存單位有KB、MB、GB、TB
《答案》A
2.()芫芫想幫爺爺將纸本老照片儲存在電腦中,必須先經過下列哪個步驟? (A)視覺化(B)實體化 (C)數位化 (D)虛擬化
《答案》C
3. ()電腦只能識別二進位系統的資料,下列何者是不需經過任何轉換,電腦就能直接讀懂的資料? (A)3366 (B)10110 (C)2222222 (D)Hello World
《答案》B
4. ( )十進位數字系統以10為基數,逢10就進位,則下列何者不符合十進位數字的表示方式? (A)10 (B)245 (C)1011 (D)1A2B
《答案》D
5. ( )在電腦中,8個位元可以視為一個單位,又稱為下列何者? (A)bit (B)byte (C)KB (D)MB
《答案》B
6. ( )若記憶卡標示容量為4GB,則約可儲存幾張大小為4MB的照片? (A)512張(B)1000張(C)1024張(D)2048張
《答案》C
7. ( )電腦資料單位的換算,下列何者不正確? (A)1 Byte = 8 bits (B)1 KB = 1024 MB (C)1 GB = 1024 MB (D)1 MB = 1024 KB
《答案》B
8. ( )老師請阿元利用課餘時間將社團活動照片轉存到電腦中,請問他將照片輸入電腦的過程稱為什麼? (A)類比化(B)數位化 (C)資料化 (D)雲端化
《答案》B
9. ( )下列何者是電腦儲存資料的最基本單位? (A)位元(bit) (B)位元組(byte) (C)百萬位元組(MB) (D)十億位元組(GB)
《答案》A
10. ( )電腦內部資料處理與儲存是採用哪一種數字系統? (A)十進位(B)八進位(C)二進位(D)十六進位
《答案》C
11. ( )下列關於二進位表示法的敘述,何者正確? (A)數字由0到9組成(B)逢2進位 (C)電腦內部運算採十進位 (D)人類習慣使用二進位
《答案》B
12. ( )下列哪一個數字不可能是二進位數? (A)1101 (B)1001 (C)102 (D)11111
《答案》C
13. ( )在電腦系統中,1KB 等於多少位元組? (A)1000 (B)1024 (C)8 (D)10
《答案》B
14. ( )ASCII 編碼系統主要用於表示下列何者? (A)中文字(B)英文字母與符號(C)圖形(D)聲音
《答案》B
15. ( )Unicode 編碼系統的優點為何? (A)只適用於英文(B)可表示全球大多數語言文字(C)所需儲存空間最小(D)已被ASCII取代
《答案》B
16. ( )點陣圖的影像品質與下列何者最相關? (A)解析度(B)檔案名稱(C)建立日期(D)檔案屬性
《答案》A
17. ( )向量圖形放大後,影像邊緣會發生什麼變化? (A)出現鋸齒狀(B)變得模糊(C)保持平滑清晰(D)顏色失真
《答案》C
18. ( )下列哪種檔案格式屬於聲音檔案? (A).jpg (B).mp3 (C).txt (D).exe
《答案》B
19. ( )下列哪種檔案格式屬於圖片檔案? (A).wav (B).png (C).docx (D).pdf
《答案》B
20. ( )將類比訊號轉換為數位訊號的過程,通常不包括下列哪個步驟? (A)取樣(B)量化(C)編碼(D)解壓縮
《答案》D
21. ( )網際網路(Internet)最初起源於哪個國家的軍事網路計畫? (A)美國(B)英國(C)蘇聯(D)日本
《答案》A
22. ( )下列何者不是常見的網路瀏覽器? (A)Chrome (B)Edge (C)Windows (D)Safari
《答案》C
23. ( )URL (Uniform Resource Locator) 中文意思為何? (A)統一資源定位器(B)網頁程式語言(C)網路傳輸協定(D)網域名稱
《答案》A
24. ( )在網址 https://www.google.com 中, "com" 代表什麼? (A)商業組織(B)政府機構(C)教育單位(D)網路組織
《答案》A
25. ( )下列哪個網域後綴通常代表台灣? (A).tw (B).cn (C).jp (D).uk
《答案》A
26. ( )無線網路 Wi-Fi 的安全性設定,下列何者較安全? (A)開放式不設密碼(B)WEP (C)WPA2/WPA3 (D)使用預設密碼
《答案》C
27. ( )關於雲端運算的敘述,下列何者正確? (A)資料只能存在自己的硬碟(B)必須購買昂貴的伺服器(C)透過網路使用資源與服務(D)不需要網路連線
《答案》C
28. ( )下列何者是常見的雲端儲存服務? (A)Google Drive (B)Photoshop (C)PowerPoint (D)Excel
《答案》A
29. ( )關於資訊安全的密碼設定原則,下列何者較佳? (A)使用生日或電話(B)長度越短越好(C)混合英文大小寫、數字與符號(D)所有帳號使用相同密碼
《答案》C
30. ( )電腦病毒通常不會透過下列哪種途徑傳播? (A)電子郵件附件(B)下載不明軟體(C)使用隨身碟(D)關閉電腦電源
《答案》D
31. ( )遇到網路霸凌時,下列哪種處理方式較適當? (A)以暴制暴(B)截圖蒐證並尋求協助(C)刪除帳號並隱忍(D)不予理會
《答案》B
32. ( )創用CC授權條款中, "NC" 代表什麼意思? (A)姓名標示(B)非商業性使用(C)禁止改作(D)相同方式分享
《答案》B
33. ( )下列何者屬於作業系統(Operating System)? (A)CPU (B)Windows 10 (C)Word (D)Mouse
《答案》B
34. ( )中央處理器(CPU) 被稱為電腦的什麼? (A)心臟(B)大腦(C)手腳(D)眼睛
《答案》B
35. ( )RAM (隨機存取記憶體) 的特性為何? (A)關機後資料會消失(B)只能讀取不能寫入(C)儲存容量比硬碟大(D)價格最便宜
《答案》A
36. ( )演算法(Algorithm) 的定義為何? (A)電腦的硬體設備(B)解決問題的步驟與方法(C)程式語言的語法(D)網路連線的方式
《答案》B
37. ( )程式設計中的 "變數" (Variable) 功能為何? (A)儲存資料(B)顯示畫面(C)播放聲音(D)列印文件
《答案》A
38. ( )在程式流程圖中, "菱形" 符號通常代表什麼? (A)開始/結束(B)處理程序(C)判斷/決策(D)輸入/輸出
《答案》C
39. ( )十進位數字 "10" 轉換為二進位數字為何? (A)1000 (B)1010 (C)1100 (D)1110
《答案》B
40. ( )下列何者不是人工智慧(AI)的應用? (A)語音助理(Siri)(B)自動駕駛車(C)傳統機械鬧鐘(D)人臉辨識系統
《答案》C
41. ( )物聯網(IoT) 的核心概念為何? (A)萬物皆可連網(B)只有電腦能上網(C)不需要感測器(D)只在實驗室使用
《答案》A
42. ( )大數據(Big Data) 的特性通常不包括下列何者? (A)資料量大(Volume) (B)速度快(Velocity) (C)多樣性(Variety) (D)單一性(Singularity)
《答案》D
43. ( )區塊鏈(Blockchain) 技術最著名的應用為何? (A)虛擬實境(B)加密貨幣(如比特幣)(C)3D列印(D)無人機
《答案》B
44. ( )下列何者屬於輸入設備? (A)螢幕(B)印表機(C)鍵盤(D)喇叭
《答案》C
45. ( )下列何者屬於輸出設備? (A)滑鼠(B)掃描器(C)麥克風(D)螢幕
《答案》D
46. ( )關於智慧財產權,下列行為何者合法? (A)擅自複製販賣他人軟體(B)在網路上散布盜版電影(C)引用他人文章並註明出處(D)將借來的CD燒錄送給朋友
《答案》C
47. ( )電子郵件地址 "student@school.edu.tw" 中, "@" 符號讀作什麼? (A)at (B)and (C)add (D)all
《答案》A
48. ( )搜尋引擎的主要功能為何? (A)製作網頁(B)尋找網路資訊(C)傳送郵件(D)播放影片
《答案》B
49. ( )下列何者是社群媒體平台? (A)Word (B)Excel (C)Instagram (D)Photoshop
《答案》C
50. ( )進行程式設計時, 發現錯誤並修正的過程稱為什麼? (A)Coding (B)Debugging (除錯) (C)Compiling (D)Running
《答案》B
`;

        function parseQuestions(text) {
            const questions = [];
            // Regex to handle the specific format from the PDF text provided in the variable
            const regex = /(\d+)\.\s*\(\s*\)\s*([\s\S]+?)\s*\(A\)\s*([\s\S]+?)\s*\(B\)\s*([\s\S]+?)\s*\(C\)\s*([\s\S]+?)\s*\(D\)\s*([\s\S]+?)\s*《答案》\s*([A-D])/g;
            
            let match;
            while ((match = regex.exec(text)) !== null) {
                questions.push({
                    id: match[1],
                    question: match[2].trim(),
                    options: {
                        A: match[3].trim(),
                        B: match[4].trim(),
                        C: match[5].trim(),
                        D: match[6].trim()
                    },
                    answer: match[7].trim()
                });
            }
            return questions;
        }

        function getRandomQuestions(allQuestions, count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
    </script>

    <!-- Start Screen -->
    <div id="startScreen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="cyber-box pink p-10 max-w-2xl w-full text-center">
            <h1 class="text-6xl font-cyber text-neon-pink mb-4 glitch" data-text="CORE CODE">CORE CODE</h1>
            <h2 class="text-3xl font-cyber text-neon-blue mb-8">INFO HUNTER // 資訊獵手</h2>
            
            <div class="space-y-4 mb-8 text-left max-w-md mx-auto">
                <div>
                    <label class="block text-neon-blue mb-1 font-cyber">CLASS ID (班級)</label>
                    <input type="text" id="inputClass" class="cyber-input w-full p-2 text-xl rounded bg-transparent" placeholder="e.g. 901">
                </div>
                <div>
                    <label class="block text-neon-blue mb-1 font-cyber">SEAT NO. (座號)</label>
                    <input type="text" id="inputSeat" class="cyber-input w-full p-2 text-xl rounded bg-transparent" placeholder="e.g. 01">
                </div>
                <div>
                    <label class="block text-neon-blue mb-1 font-cyber">CODENAME (姓名)</label>
                    <input type="text" id="inputName" class="cyber-input w-full p-2 text-xl rounded bg-transparent" placeholder="YOUR NAME">
                </div>
            </div>

            <div class="text-left text-gray-300 mb-8 text-sm border border-gray-700 p-4 rounded bg-black/50">
                <h3 class="text-neon-green font-bold mb-2">/// MISSION BRIEFING ///</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>操控數據蛇 (Data Snake) 探索迷宮</li>
                    <li>依序蒐集 1-25 號核心旗幟 (Flags)</li>
                    <li>觸碰旗幟 -> 進入答題 -> 答對獲得積分與金幣</li>
                    <li>答錯會扣除生命值，請謹慎作答</li>
                    <li>連續答對可獲得連勝獎勵 (Streak Bonus)</li>
                    <li>蒐集稀有道具開啟「七彩超頻模式」</li>
                </ul>
            </div>

            <button onclick="startGame()" class="cyber-btn px-12 py-4 text-2xl font-bold rounded w-full">
                INITIALIZE SYSTEM
            </button>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none hidden z-20">
        <div class="cyber-box p-4 min-w-[200px]">
            <div class="text-neon-blue font-cyber text-sm">OPERATOR</div>
            <div id="displayPlayer" class="text-xl font-bold text-white">---</div>
            <div class="mt-2 text-neon-pink font-cyber text-sm">TARGET</div>
            <div class="text-2xl font-bold text-white flex items-center">
                <i class="fas fa-flag mr-2 text-neon-pink"></i>
                <span id="displayTarget">1</span> / 25
            </div>
        </div>

        <div class="flex flex-col items-center">
             <div id="countdownOverlay" class="hidden text-8xl font-cyber text-neon-yellow glitch font-bold" data-text="5">5</div>
        </div>

        <div class="cyber-box green p-4 min-w-[200px] text-right">
            <div class="text-neon-green font-cyber text-sm">SCORE</div>
            <div id="displayScore" class="text-3xl font-bold text-white">0000</div>
            <div class="flex justify-end gap-4 mt-2">
                <div>
                    <div class="text-neon-yellow font-cyber text-xs">COINS</div>
                    <div id="displayCoins" class="text-xl text-white"><i class="fas fa-coins text-yellow-400"></i> 0</div>
                </div>
                <div>
                    <div class="text-neon-blue font-cyber text-xs">STREAK</div>
                    <div id="displayStreak" class="text-xl text-white">x0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="relative hidden">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="absolute inset-0 z-40 hidden items-center justify-center modal-overlay">
        <div class="cyber-box p-8 max-w-3xl w-full mx-4 bg-black">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h2 class="text-2xl font-cyber text-neon-blue">
                    <i class="fas fa-terminal mr-2"></i>DECRYPTION PROTOCOL
                </h2>
                <div id="quizTimer" class="text-4xl font-cyber text-neon-pink animate-pulse">05</div>
            </div>
            
            <div id="quizContent" class="hidden">
                <p id="questionText" class="text-xl md:text-2xl mb-8 leading-relaxed font-bold text-white"></p>
                <div id="optionsGrid" class="grid grid-cols-1 gap-4 mb-6">
                    <!-- Options injected here -->
                </div>
                <div id="feedbackArea" class="hidden text-center p-4 mb-4 rounded font-bold text-xl"></div>
                <button id="continueBtn" onclick="resumeGame()" class="hidden cyber-btn px-8 py-2 w-full text-xl">
                    CONTINUE MISSION
                </button>
            </div>

            <div id="quizCountdown" class="text-center py-20">
                <div class="text-6xl font-cyber text-neon-green mb-4">DECRYPTING...</div>
                <div class="loading-bar w-full h-2 bg-gray-800 rounded overflow-hidden">
                    <div class="h-full bg-neon-green w-0 animate-[load_5s_linear_forwards]"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="endScreen" class="absolute inset-0 z-50 hidden flex-col items-center justify-center bg-black/95">
        <div class="cyber-box green p-10 max-w-4xl w-full text-center max-h-[90vh] overflow-y-auto">
            <h1 class="text-5xl font-cyber text-neon-green mb-2 glitch" data-text="MISSION COMPLETE">MISSION COMPLETE</h1>
            <h2 id="endTitle" class="text-2xl text-white mb-8"></h2>

            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm">TOTAL SCORE</div>
                    <div id="endScore" class="text-4xl text-neon-blue font-bold">0</div>
                </div>
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm">ACCURACY</div>
                    <div id="endAccuracy" class="text-4xl text-neon-pink font-bold">0%</div>
                </div>
                <div class="bg-gray-900 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm">COINS COLLECTED</div>
                    <div id="endCoins" class="text-4xl text-neon-yellow font-bold">0</div>
                </div>
            </div>

            <div id="rankDisplay" class="text-3xl font-bold mb-4 font-cyber"></div>
            <div id="rankMessage" class="text-xl text-red-400 mb-8 italic"></div>

            <!-- Leaderboard -->
            <div class="mb-8">
                <h3 class="text-neon-blue font-cyber mb-4 border-b border-gray-800 pb-2">TOP AGENTS</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-gray-500 font-cyber">
                            <tr>
                                <th class="p-2">RANK</th>
                                <th class="p-2">AGENT</th>
                                <th class="p-2">CLASS</th>
                                <th class="p-2">SCORE</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="font-mono text-white">
                            <tr><td colspan="4" class="p-4 text-center">CONNECTING TO DATABASE...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <button onclick="location.reload()" class="cyber-btn px-12 py-3 text-xl font-bold">
                REBOOT SYSTEM
            </button>
        </div>
    </div>

    <!-- Audio Elements (Generated tones will be used, but keeping tags for structure) -->
    <script>
        // Sound System using Web Audio API for self-containment
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const SFX = {
            hover: () => playTone(400, 'sine', 0.1),
            select: () => playTone(800, 'square', 0.1),
            flag: () => { playTone(1200, 'sine', 0.1); setTimeout(() => playTone(1800, 'sine', 0.2), 100); },
            correct: () => { playTone(600, 'sine', 0.1); setTimeout(() => playTone(900, 'sine', 0.2), 100); },
            wrong: () => { playTone(150, 'sawtooth', 0.3); setTimeout(() => playTone(100, 'sawtooth', 0.4), 200); },
            powerup: () => { 
                [400, 500, 600, 800, 1000].forEach((f, i) => setTimeout(() => playTone(f, 'square', 0.1), i * 50));
            }
        };
    </script>

    <script>
        // --- GAME LOGIC ---
        
        // Config
        const GRID_SIZE = 25; // 25px per cell
        const COLS = 32; // 800px / 25
        const ROWS = 24; // 600px / 25
        const TOTAL_FLAGS = 25;
        
        // State
        let player = { class: '', seat: '', name: '' };
        let gameActive = false;
        let snake = [];
        let direction = { x: 1, y: 0 };
        let nextDirection = { x: 1, y: 0 };
        let currentFlagTarget = 1; // 1 to 25
        let flags = []; // Position of all flags {x,y, id, collected}
        let score = 0;
        let coins = 0;
        let streak = 0;
        let questions = [];
        let currentQuestionIndex = 0; // Tracks which question from the set of 25
        let quizActive = false;
        let gameLoopId;
        let rainbowMode = false;
        let rainbowTimer = 0;
        let correctCount = 0;
        let items = []; // {x, y, type: 'diamond'|'food'}

        // Maze Generation (Simple Grid with random walls)
        let walls = [];
        
        function initGame() {
            // Parse questions
            const allQuestions = parseQuestions(RAW_PDF_TEXT);
            questions = getRandomQuestions(allQuestions, 25);
            
            // Setup Snake
            snake = [
                {x: 5, y: 5},
                {x: 4, y: 5},
                {x: 3, y: 5}
            ];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
            
            // Generate Maze Walls (Outer bounds + random internal blocks)
            walls = [];
            // Random internal walls (avoid spawn area and too density)
            for(let i=0; i<60; i++) {
                let wx = Math.floor(Math.random() * (COLS - 2)) + 1;
                let wy = Math.floor(Math.random() * (ROWS - 2)) + 1;
                // Avoid spawn
                if(wx < 10 && wy < 10) continue;
                walls.push({x: wx, y: wy});
            }

            // Generate Flags (Avoid walls and each other)
            flags = [];
            for(let i=1; i<=TOTAL_FLAGS; i++) {
                let pos = getValidPosition();
                flags.push({id: i, x: pos.x, y: pos.y, collected: false});
            }

            // Init items
            spawnItem();
        }

        function getValidPosition() {
            let valid = false;
            let pos = {x:0, y:0};
            while(!valid) {
                pos.x = Math.floor(Math.random() * COLS);
                pos.y = Math.floor(Math.random() * ROWS);
                
                // Check collision with walls
                let hitWall = walls.some(w => w.x === pos.x && w.y === pos.y);
                // Check collision with snake
                let hitSnake = snake.some(s => s.x === pos.x && s.y === pos.y);
                // Check collision with existing flags
                let hitFlag = flags.some(f => f.x === pos.x && f.y === pos.y);

                if(!hitWall && !hitSnake && !hitFlag) valid = true;
            }
            return pos;
        }

        function spawnItem() {
            if(Math.random() > 0.3) { // 70% chance to have an item
                let pos = getValidPosition();
                items.push({x: pos.x, y: pos.y, type: Math.random() > 0.5 ? 'diamond' : 'food'});
            }
        }

        function startGame() {
            const c = document.getElementById('inputClass').value;
            const s = document.getElementById('inputSeat').value;
            const n = document.getElementById('inputName').value;

            if(!c || !s || !n) {
                alert("PLEASE ENTER ALL IDENTIFICATION DATA");
                return;
            }

            player = { class: c, seat: s, name: n };
            document.getElementById('displayPlayer').textContent = `${c}-${s} ${n}`;
            
            // Hide Start, Show Game
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');

            initGame();
            
            // Countdown
            startCountdown();
        }

        function startCountdown() {
            const el = document.getElementById('countdownOverlay');
            el.classList.remove('hidden');
            let count = 5;
            el.dataset.text = count;
            el.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    el.dataset.text = count;
                    el.textContent = count;
                    SFX.select();
                } else {
                    clearInterval(timer);
                    el.textContent = "GO!";
                    el.dataset.text = "GO!";
                    SFX.powerup();
                    setTimeout(() => {
                        el.classList.add('hidden');
                        gameActive = true;
                        gameLoop();
                    }, 1000);
                }
            }, 1000);
        }

        // Input Handling
        document.addEventListener('keydown', e => {
            if(!gameActive) return;
            switch(e.key) {
                case 'ArrowUp': if(direction.y === 0) nextDirection = {x:0, y:-1}; break;
                case 'ArrowDown': if(direction.y === 0) nextDirection = {x:0, y:1}; break;
                case 'ArrowLeft': if(direction.x === 0) nextDirection = {x:-1, y:0}; break;
                case 'ArrowRight': if(direction.x === 0) nextDirection = {x:1, y:0}; break;
            }
        });

        function gameLoop() {
            if(!gameActive) return;
            
            update();
            draw();
            
            // Control Speed (Simple fixed speed)
            let speed = rainbowMode ? 80 : 120; // Faster in rainbow mode
            setTimeout(() => {
                requestAnimationFrame(gameLoop);
            }, speed);
        }

        function update() {
            direction = nextDirection;
            
            // Move Head
            const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

            // Wrap around (Pacman style)
            if(head.x < 0) head.x = COLS - 1;
            if(head.x >= COLS) head.x = 0;
            if(head.y < 0) head.y = ROWS - 1;
            if(head.y >= ROWS) head.y = 0;

            // Check Self Collision
            if(snake.some(s => s.x === head.x && s.y === head.y)) {
                score = Math.max(0, score - 50);
                streak = 0;
                updateHUD();
                SFX.wrong();
                // Reset snake pos
                snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
                return; 
            }

            // Check Wall Collision
            if(walls.some(w => w.x === head.x && w.y === head.y)) {
                 // Bounce back / Stop
                 return; // Don't move
            }

            snake.unshift(head); // Add new head

            // Check Items
            let itemIndex = items.findIndex(i => i.x === head.x && i.y === head.y);
            if(itemIndex !== -1) {
                let item = items[itemIndex];
                items.splice(itemIndex, 1);
                SFX.powerup();
                if(item.type === 'diamond') {
                    activateRainbowMode();
                } else {
                    score += 10;
                }
                updateHUD();
            }

            // Check Flag Collision
            let hitFlag = flags.find(f => f.x === head.x && f.y === head.y);
            
            if(hitFlag) {
                if(hitFlag.id === currentFlagTarget) {
                    // Correct Flag
                    SFX.flag();
                    gameActive = false; // Pause Game
                    startQuiz(hitFlag.id);
                } else if(hitFlag.id > currentFlagTarget && !hitFlag.collected) {
                    // Wrong order flag, just ignore
                }
            } else {
                // Remove tail if no growth needed
                snake.pop(); 
            }

            // Rainbow Timer
            if(rainbowMode) {
                rainbowTimer -= 0.12; // approx ms
                if(rainbowTimer <= 0) rainbowMode = false;
            }
        }

        function activateRainbowMode() {
            rainbowMode = true;
            rainbowTimer = 180; // Approx 15 seconds
        }

        function draw() {
            const cvs = document.getElementById('gameCanvas');
            const ctx = cvs.getContext('2d');

            // Clear
            ctx.clearRect(0, 0, cvs.width, cvs.height);

            // Draw Walls
            ctx.fillStyle = '#1a1a1a';
            ctx.shadowBlur = 0;
            walls.forEach(w => {
                ctx.fillRect(w.x * GRID_SIZE, w.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(w.x * GRID_SIZE, w.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            });

            // Draw Items
            items.forEach(i => {
                if(i.type === 'diamond') {
                    ctx.fillStyle = '#0ff';
                    ctx.shadowColor = '#0ff';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    let cx = i.x * GRID_SIZE + GRID_SIZE/2;
                    let cy = i.y * GRID_SIZE + GRID_SIZE/2;
                    ctx.moveTo(cx, cy - 8);
                    ctx.lineTo(cx + 8, cy);
                    ctx.lineTo(cx, cy + 8);
                    ctx.lineTo(cx - 8, cy);
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#f00';
                    ctx.shadowColor = '#f00';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(i.x * GRID_SIZE + GRID_SIZE/2, i.y * GRID_SIZE + GRID_SIZE/2, 6, 0, Math.PI*2);
                    ctx.fill();
                }
            });

            // Draw Flags
            flags.forEach(f => {
                if(f.collected) return;
                
                let isTarget = f.id === currentFlagTarget;
                
                ctx.shadowBlur = isTarget ? 15 : 0;
                ctx.shadowColor = isTarget ? '#ff00ff' : 'transparent';
                ctx.fillStyle = isTarget ? '#ff00ff' : '#555';
                
                // Flag Pole
                ctx.fillRect(f.x * GRID_SIZE + 4, f.y * GRID_SIZE + 4, 2, 16);
                // Flag Banner
                ctx.fillRect(f.x * GRID_SIZE + 6, f.y * GRID_SIZE + 4, 10, 8);
                
                // Number
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 0;
                ctx.font = '10px Arial';
                ctx.fillText(f.id, f.x * GRID_SIZE + 7, f.y * GRID_SIZE + 12);
            });

            // Draw Snake
            snake.forEach((s, i) => {
                let color = rainbowMode ? `hsl(${Date.now()/5 % 360}, 100%, 50%)` : '#0f0';
                if(i === 0) color = '#fff'; // Head

                ctx.fillStyle = color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = color;
                
                ctx.fillRect(s.x * GRID_SIZE + 1, s.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2);
            });
        }

        // --- QUIZ LOGIC ---

        function startQuiz(flagId) {
            const modal = document.getElementById('quizModal');
            const content = document.getElementById('quizContent');
            const countdown = document.getElementById('quizCountdown');
            const timerDisplay = document.getElementById('quizTimer');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.classList.add('hidden');
            countdown.classList.remove('hidden');
            
            // 5 second visual countdown
            setTimeout(() => {
                countdown.classList.add('hidden');
                content.classList.remove('hidden');
                showQuestion();
            }, 5000);
        }

        function showQuestion() {
            // Get current question based on flag progress (0-indexed)
            let qIndex = currentFlagTarget - 1;
            if(qIndex >= questions.length) qIndex = questions.length - 1; // Safety
            
            const q = questions[qIndex];
            
            document.getElementById('questionText').textContent = `Q${currentFlagTarget}. ${q.question}`;
            
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            ['A', 'B', 'C', 'D'].forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'answer-option border border-cyan-500 p-4 rounded text-left hover:bg-cyan-900/30 text-lg relative group';
                btn.innerHTML = `<span class="text-neon-pink font-bold mr-2">${key}.</span> ${q.options[key]}`;
                btn.onmouseenter = () => SFX.hover();
                btn.onclick = () => handleAnswer(key, q.answer);
                grid.appendChild(btn);
            });
            
            document.getElementById('feedbackArea').classList.add('hidden');
            document.getElementById('continueBtn').classList.add('hidden');
        }

        function handleAnswer(selected, correct) {
            const feedback = document.getElementById('feedbackArea');
            const opts = document.getElementById('optionsGrid').children;
            
            // Disable buttons
            for(let btn of opts) btn.disabled = true;

            if(selected === correct) {
                // Correct
                SFX.correct();
                feedback.textContent = "CORRECT // 答案正確";
                feedback.className = "text-center p-4 mb-4 rounded font-bold text-xl bg-green-900/50 text-neon-green border border-green-500";
                
                score += 100;
                correctCount++;
                
                // Streak Logic
                streak++;
                let bonus = 0;
                if([3, 5, 10, 15, 20].includes(streak)) {
                    bonus = streak * 50; // Extra bonus
                    score += bonus;
                }
                
                coins += (1 + Math.floor(streak/3)); // 1 coin base + streak bonus
                
                // Snake grows
                let tail = snake[snake.length-1];
                snake.push({...tail});

            } else {
                // Wrong
                SFX.wrong();
                feedback.textContent = `WRONG // 答案錯誤 (正確答案: ${correct})`;
                feedback.className = "text-center p-4 mb-4 rounded font-bold text-xl bg-red-900/50 text-red-500 border border-red-500";
                streak = 0;
            }
            
            feedback.classList.remove('hidden');
            document.getElementById('continueBtn').classList.remove('hidden');
            updateHUD();
        }

        function resumeGame() {
            document.getElementById('quizModal').classList.add('hidden');
            document.getElementById('quizModal').classList.remove('flex');
            
            // Mark flag as collected
            let f = flags.find(flag => flag.id === currentFlagTarget);
            if(f) f.collected = true;
            
            currentFlagTarget++;
            document.getElementById('displayTarget').textContent = currentFlagTarget <= 25 ? currentFlagTarget : 25;

            // Spawn new item chance
            spawnItem();

            if(currentFlagTarget > 25) {
                endGame();
            } else {
                gameActive = true;
                gameLoop();
            }
        }

        function updateHUD() {
            document.getElementById('displayScore').textContent = score;
            document.getElementById('displayCoins').innerHTML = `<i class="fas fa-coins text-yellow-400"></i> ${coins}`;
            document.getElementById('displayStreak').textContent = `x${streak}`;
        }

        function endGame() {
            gameActive = false;
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('endScreen').classList.add('flex');

            const acc = Math.round((correctCount / 25) * 100);
            
            document.getElementById('endScore').textContent = score;
            document.getElementById('endAccuracy').textContent = `${acc}%`;
            document.getElementById('endCoins').textContent = coins;

            // Rank Logic
            let rank = "ROOKIE";
            let rankClass = "text-gray-400";
            if(score >= 3000) { rank = "CYBER LEGEND"; rankClass = "text-neon-yellow"; }
            else if(score >= 2500) { rank = "ELITE HACKER"; rankClass = "text-neon-pink"; }
            else if(score >= 2000) { rank = "SENIOR AGENT"; rankClass = "text-neon-green"; }
            else if(score >= 1000) { rank = "OPERATOR"; rankClass = "text-neon-blue"; }
            
            const rDisplay = document.getElementById('rankDisplay');
            rDisplay.textContent = rank;
            rDisplay.className = `text-5xl font-bold mb-4 font-cyber ${rankClass} glitch`;
            rDisplay.dataset.text = rank;

            if(score < 600 || acc < 60) {
                document.getElementById('rankMessage').textContent = "⚠️ 警告：核心數據同步率過低。請熟讀期末考題庫內容再來挑戰。";
            } else {
                document.getElementById('rankMessage').textContent = "SYSTEM SYNC COMPLETE. EXCELLENT WORK.";
            }

            SFX.powerup(); // Victory sound

            // Save to Firebase
            const playerData = {
                name: player.name,
                class: player.class,
                seat: player.seat,
                score: score,
                accuracy: acc,
                coins: coins
            };
            window.saveScore(playerData);

            // Load Leaderboard
            window.subscribeLeaderboard(updateLeaderboardUI);
        }

        function updateLeaderboardUI(data) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            data.forEach((d, i) => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-800 hover:bg-gray-800/50";
                tr.innerHTML = `
                    <td class="p-2 text-neon-blue">#${i+1}</td>
                    <td class="p-2 text-white font-bold">${d.name}</td>
                    <td class="p-2 text-gray-400">${d.class}-${d.seat}</td>
                    <td class="p-2 text-neon-pink font-mono">${d.score}</td>
                `;
                tbody.appendChild(tr);
            });

            if(data.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">NO DATA RECORDS FOUND</td></tr>';
            }
        }

    </script>
    
    <style>
        @keyframes load {
            0% { width: 0; }
            100% { width: 100%; }
        }
    </style>
</body>
</html>