<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>核心代碼：資訊獵手 | Core Code: Info Hunter</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- FIREBASE 設定區 ---
        // 如果您在 GitHub Pages 或本地運行，請將下方 {} 替換為您的 Firebase Config
        // 例如: const customConfig = { apiKey: "...", authDomain: "...", ... };
        const customConfig = {}; 
        
        // 環境變數檢測 (預覽環境用)
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // 最終使用的 Config: 優先使用環境變數，其次使用手動設定的 customConfig
        const firebaseConfig = Object.keys(envConfig).length > 0 ? envConfig : customConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Mock Data (僅在連線失敗或無資料時備用顯示)
        const MOCK_LEADERBOARD = [
            { name: "Neo", class: "901", seat: "01", score: 5200 },
            { name: "Trinity", class: "902", seat: "05", score: 4800 },
            { name: "Morpheus", class: "903", seat: "10", score: 4500 },
            { name: "Cipher", class: "901", seat: "12", score: 4100 },
            { name: "Tank", class: "904", seat: "08", score: 3900 }
        ];

        // 渲染排行榜 (共用函式)
        window.renderLeaderboard = (data) => {
            const tbody = document.getElementById('leaderboardBody');
            if(tbody) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">暫無排名資料...快來搶第一！</td></tr>';
                } else {
                    data.forEach((d, i) => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-800 hover:bg-gray-800/50";
                        tr.innerHTML = `
                            <td class="p-2 text-neon-blue font-cyber">#${i+1}</td>
                            <td class="p-2 text-white font-bold">${d.name}</td>
                            <td class="p-2 text-gray-400 font-mono text-sm">${d.class}-${d.seat}</td>
                            <td class="p-2 text-neon-purple font-mono font-bold">${d.score}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            // Live Leaderboard (In-Game)
            const liveBody = document.getElementById('liveLeaderboardList');
            if(liveBody) {
                liveBody.innerHTML = '';
                if (data.length === 0) {
                    liveBody.innerHTML = '<div class="text-center text-gray-500 text-xs">WAITING FOR DATA...</div>';
                } else {
                    data.slice(0, 10).forEach((d, i) => {
                        const div = document.createElement('div');
                        let rankColor = "text-gray-400";
                        if(i===0) rankColor = "text-yellow-400";
                        if(i===1) rankColor = "text-gray-300";
                        if(i===2) rankColor = "text-orange-400";

                        div.className = "flex justify-between items-center text-sm py-1 border-b border-gray-800/50";
                        div.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="font-cyber font-bold w-6 ${rankColor}">#${i+1}</span>
                                <span class="text-white truncate max-w-[80px]">${d.name}</span>
                            </div>
                            <span class="text-neon-blue font-mono">${d.score}</span>
                        `;
                        liveBody.appendChild(div);
                    });
                }
            }
        };

        // Firebase 初始化邏輯
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                window.initFirebase = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                    }
                };

                window.saveScore = async (playerData) => {
                    if (!auth.currentUser) return;
                    try {
                        // 使用統一的路徑結構
                        // 注意：如果您自己託管，建議將路徑簡化為 collection(db, 'leaderboard') 即可
                        // 這裡為了相容預覽環境，保留 artifacts 路徑
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                            ...playerData,
                            timestamp: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error adding score: ", e);
                    }
                };

                window.subscribeLeaderboard = () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard')); 
                    return onSnapshot(q, (snapshot) => {
                        const scores = [];
                        snapshot.forEach((doc) => {
                            scores.push(doc.data());
                        });
                        // Sort locally
                        scores.sort((a, b) => b.score - a.score || b.accuracy - a.accuracy);
                        
                        // 更新畫面
                        window.renderLeaderboard(scores.slice(0, 10));
                    }, (error) => {
                        console.warn("Leaderboard read error (likely permission or empty):", error);
                        // 只有在讀取失敗時才顯示 Mock Data 或是空狀態
                        // 這裡選擇不顯示 Mock，讓用戶知道連線有問題或沒資料
                        window.renderLeaderboard([]); 
                    });
                };

                window.initFirebase();
            } catch (e) {
                console.error("Firebase Init Error:", e);
                window.saveScore = () => {};
                window.subscribeLeaderboard = () => window.renderLeaderboard(MOCK_LEADERBOARD);
            }
        } else {
            console.warn("No Firebase Config Found. Using Mock Mode.");
            window.saveScore = () => { console.log("Mock Save Score"); };
            window.subscribeLeaderboard = () => {
                window.renderLeaderboard(MOCK_LEADERBOARD);
            };
        }
    </script>

    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #0aff00;
            --neon-yellow: #fcee0a;
            --neon-gold: #FFD700;
            --neon-red: #ff003c;
            --bg-dark: #050505;
            --glass: rgba(10, 10, 20, 0.95);
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden;
            cursor: default;
            user-select: none;
        }

        .font-cyber {
            font-family: 'Orbitron', sans-serif;
        }

        .text-neon-blue { color: var(--neon-cyan); text-shadow: 0 0 5px var(--neon-cyan); }
        .text-neon-purple { color: var(--neon-purple); text-shadow: 0 0 5px var(--neon-purple); }
        .text-neon-green { color: var(--neon-green); text-shadow: 0 0 5px var(--neon-green); }
        .text-neon-yellow { color: var(--neon-yellow); text-shadow: 0 0 5px var(--neon-yellow); }
        
        /* Title Gradient */
        .text-gradient-cyber {
            background: linear-gradient(to right, #00f3ff, #bc13fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.6);
            font-weight: 900;
            letter-spacing: 2px;
        }

        .cyber-box {
            background: var(--glass);
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3), inset 0 0 30px rgba(0, 243, 255, 0.1);
            position: relative;
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 20px), 
                calc(100% - 20px) 100%, 
                0 100%
            );
        }
        .cyber-box.purple { border-color: var(--neon-purple); box-shadow: 0 0 15px rgba(188, 19, 254, 0.3); }
        .cyber-box.green { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(10, 255, 0, 0.3); }
        
        .cyber-btn {
            background: rgba(0, 243, 255, 0.1);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
            transition: all 0.2s;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cyber-btn:hover { 
            background: var(--neon-cyan); 
            color: #000; 
            box-shadow: 0 0 20px var(--neon-cyan); 
            transform: scale(1.02); 
        }
        .cyber-btn:active { transform: scale(0.98); background: #fff; box-shadow: 0 0 30px #fff; }

        .cyber-input {
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
        }
        .cyber-input:focus { outline: none; box-shadow: 0 0 15px var(--neon-cyan); }

        #gameCanvas {
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            background-color: #050505;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .modal-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); }

        .glitch { position: relative; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .glitch::before { left: 2px; text-shadow: -1px 0 #bc13fe; clip: rect(24px, 550px, 90px, 0); animation: glitch-anim-2 3s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 #00f3ff; clip: rect(85px, 550px, 140px, 0); animation: glitch-anim 2.5s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { clip: rect(11px, 9999px, 81px, 0); } 100% { clip: rect(48px, 9999px, 54px, 0); } }
        @keyframes glitch-anim-2 { 0% { clip: rect(65px, 9999px, 100px, 0); } 100% { clip: rect(58px, 9999px, 66px, 0); } }

        .answer-option { margin: 0 4px; transition: all 0.2s; }
        .answer-option:hover, .answer-option.selected {
            background: rgba(0, 243, 255, 0.15);
            border-color: var(--neon-yellow);
            box-shadow: 0 0 10px var(--neon-yellow);
            transform: translateX(5px);
        }

        .mystery-fruit-glow {
            filter: drop-shadow(0 0 5px #FFD700) drop-shadow(0 0 15px #FFA500);
            animation: pulse-glow 1s infinite alternate;
        }
        @keyframes pulse-glow {
            0% { filter: drop-shadow(0 0 5px #FFD700) drop-shadow(0 0 15px #FFA500); transform: scale(1); }
            100% { filter: drop-shadow(0 0 10px #FFD700) drop-shadow(0 0 25px #FFA500); transform: scale(1.2); }
        }

        /* Health Bar */
        .hp-bar-container {
            width: 100%;
            height: 12px;
            background: #222;
            border: 1px solid #444;
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }
        .hp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f3ff, #0aff00);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        .hp-critical {
            animation: hp-blink 0.5s infinite;
            background: linear-gradient(90deg, #ff003c, #ff5e00) !important;
            box-shadow: 0 0 15px #ff003c;
        }
        @keyframes hp-blink {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Footer */
        #gameFooter { transition: opacity 0.5s; }
        #gameFooter.hidden-footer { opacity: 0; pointer-events: none; }
        
        /* Quiz Modal Fixes */
        .quiz-modal-inner { 
            max-height: 90vh; 
            height: auto;
            min-height: 60vh;
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }
        .quiz-modal-inner::-webkit-scrollbar { width: 6px; }
        .quiz-modal-inner::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 3px; }
        .quiz-modal-inner::-webkit-scrollbar-track { background: #111; }
        
        /* Live Leaderboard Style */
        #inGameLeaderboard {
            pointer-events: none; 
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            border-left: 2px solid var(--neon-purple);
            box-shadow: -5px 0 15px rgba(188, 19, 254, 0.2);
            top: 200px; 
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center bg-black overflow-hidden">

    <!-- DATA -->
    <script>
        const RAW_PDF_TEXT = `
1.	為了提升資訊安全，我們可以從實體安全、軟體安全和網路安全三個層面著手。下列哪一項作法，最主要屬於「網路安全」的範疇？(A)在重要的電腦設備旁加裝監視器(B)定期將電腦中的重要資料備份到外接硬碟(C)在瀏覽網頁時，盡量選擇網址以「https」開頭的網站(D)安裝防毒軟體並定期更新病毒碼
《答案》C
2.	小君要設計一個購票程式，當使用者輸入年齡之後，可以自動判斷應購買一般票、兒童票、或是敬老票。若要完成上述判斷的功能，應該使用下列哪一種流程結構？(A)循序結構(B)選擇結構(C)重複結構
《答案》B
3.	如果想將自己設計的演算法表達給同學看，採用下列何種方式表達較最為適合？(A)流程圖(B)折線圖(C)心智圖(D)長條圖
《答案》A
4.	下列何種程式語言的語法最接近人類的語言，使用上最易理解？(A)機器語言(B)組合語言(C)高階語言
《答案》C
5.	下列關於Scratch的敘述，何者正確？(A)屬於低階程式語言(B)是視覺化的程式設計工具(C)完全不需要學習就能撰寫程式(D)必須輸入文字指令來撰寫程式
《答案》B
6.	下列哪一類程式語言，其程式通常可以在不同的電腦系統上執行？(A)機器語言(B)組合語言(C)低階語言(D)高階語言
《答案》D
7.	在Scratch中，如果要讓角色透過對話框說出文字，應該使用哪一類的程式積木？(A)動作類(B)外觀類(C)音效類(D)偵測類
《答案》B
8.	已知某角色有兩種不同的造型，該用哪一類的指令，才能控制角色的造型變化？(A)控制類(B)事件類(C)外觀類(D)動作類
《答案》C
9.	在Scratch中，以下哪一個選項不是新增角色的方式？(A)從電腦中上傳角色檔案(B)從範例庫中選擇角色(C)隨機產生新角色(D)透過輸入文字指令來創建角色
《答案》D
10.	若某角色的原始高度是200點，當執行了指令之後，角色的高度變為多少點？(A)100(B)150(C)200(D)300
《答案》A
11.	下列哪些情境有運用到資訊科技？(A)用電腦撰寫報告(B)用手機傳送簡訊(C)圖書館刷條碼借書(D)以上都有應用到資訊科技
《答案》D
12.	資訊科技越來越發達，對我們的生活造成許多影響，下列何者屬於「正面」的影響？(A)學生不一定要到學校，在家中一樣可以遠距教學上課(B)網路交友風行，造成真實世界的社交關係疏離(C)線上購物快速發展，網路詐騙案件爆增(D)資訊設備越來越輕巧，偷拍事件頻傳
《答案》A
13.	隨著資訊科技的發展與普及，下列何種設施的數量最可能越來越多？(A)郵筒(B)公共電話(C)販售紙本書籍的書店(D)充電設備租借
《答案》D
14.	資訊科技的發展，對我們生活的食、衣、住、行、育、樂等方面都帶來不同的影響，下列何者是對「住」帶來的改變？(A)公車電子看板顯示車輛預計到站時間(B)用手機訂購外送飲料(C)看網路影片學習做蛋糕(D)利用智慧家電管理水電照明
《答案》D
15.	資訊科技的發展，讓許多事變得更方便。試問「利用手機導航定位」對應的是以前的何種行為？(A)在戶外利用公共電話與他人聯絡(B)到郵局寄送信件(C)看地圖找地址(D)到相館沖洗照片
《答案》C
16.	資訊科技的發展也可能造成某些衝擊，下列技術的應用與衝擊的配對說明，何者錯誤？(A)電子郵件：郵局信件業務大量減少(B)無人智慧商店：店員工作機會減少(C)遠距教學：增加人員接觸、造成疫情擴散(D)數位閱讀：紙製書銷量消退、書店數量大減
《答案》C
17.	受到疫情影響，必要時會停止人員到校上課，改採遠距教學。遠距教學雖然方便，但仍有下列
18.	哪些條件限制？(甲)要有硬體設備。(乙)要有操作軟體的能力。(丙)要有網路服務。(丁)要有家長陪同。(A)甲乙丙丁均是(B)僅甲乙丙(C)僅甲乙(D)僅甲
《答案》B
19.	資訊科技的發展趨勢包含「智慧化」、「無人化」和「雲端化」。下列哪一種應用情境最能體現「無人化」的特色？(A)智慧交通系統能依交通狀況，調控交通號誌時間的長短(B)企業使用雲端儲存服務來管理資料(C)透過網路影片學習做蛋糕(D)生產線上使用機器人進行各項工作
《答案》D
20.	小宇存放在網路硬碟的資料，不知什麼原因被刪改破壞，則此網路硬碟服務違反了資訊安全三原則中的哪一項目？(A)機密性(B)完整性(C)可用性(D)正確性
《答案》B
21.	下列資訊安全防護措施中，何者可維護實體安全的防護，同時可確保資訊安全三原則中的「可用性」？(A)設定防火牆(B)設置開機密碼(C)安裝防毒軟體(D)裝設不斷電系統
《答案》D
22.	下列何者為電腦防火牆的主要用途？(A)抵禦外來的入侵與威脅(B)定期為電腦系統掃描病毒(C)將檔案進行加密保護(D)防止電腦硬體損毀
《答案》A
23.	當我們收到一封附加不明檔案的信件時，下列哪些作法較正確？甲.直接打開，確認檔案內容乙.如果寄件人是朋友，就可以放心開啟檔案丙.直接聯絡朋友，確認檔案的內容與目的丁.利用防毒軟體進行掃毒(A)甲乙丙丁均正確(B)甲乙丙丁均不正確(C)僅乙丙丁正確(D)僅丙丁正確
《答案》D
24.	下列哪一種措施可以防止駭客及惡意軟體透過網路存取電腦，提升電腦抵禦外來威脅的防護力？(A)開啟防火牆(B)定時備份檔案(C)安裝不斷電系統(D)使用隨身碟存放重要檔案
《答案》A
25.	資訊安全可分為實體安全、軟體安全及網路安全三個層面。下列何者屬於「實體安全」的範疇？(A)設定防火牆(B)設置密碼(C)安裝防毒軟體(D)裝設不斷電系統
《答案》D
26.	下列何者不是演算法的特性？(A)明確描述過程中的每一個步驟(B)要在有限的步驟內結束(C)要能快速解決問題(D)必須能正確解決問題
《答案》C
27.	下列關於演算法的敘述，何者錯誤？(A)演算法可以理解為「解決問題的方法」(B)依照演算法的步驟執行，必須能正確解決問題(C)針對一個問題，可能有多種可行的演算法(D)每種演算法的結果、效率都相同
《答案》D
29.	下列關於流程圖的繪製原則，何者錯誤？(A)流程圖中的每個步驟，均應使用標準符號繪製(B)用帶箭頭的流程線條來標示工作處理的流向(C)流程線條盡量交叉繪製以節省空間(D)繪製方向由上而下，由左至右
《答案》C
30.	針對「如何獲得整潔比賽第一名」這個問題，小圓制定了解決方案「甲」並以文字記錄，小佑制定了解決方案「乙」並將步驟畫成流程圖。試問，下列敘述何者正確？(A)因問題相同，所以甲、乙的執行步驟也會相同(B)只有畫成流程圖的「乙」才能稱為演算法(C)文字是人類語言，只有甲能稱為演算法(D)甲和乙都稱為演算法
《答案》D
31.	如果一個程式需要判斷使用者輸入的成績是否及格（60分以上），並根據判斷結果輸出「及格」或「不及格」。這最適合使用哪一種流程控制結構？(A)循序結構(B)重複結構(C)迴圈結構(D)雙向選擇結構
《答案》D
32.	現在常見的程式語言如C、C++、Python、Java等，屬於下列何種程式語言？(A)機器語言(B)組合語言(C)高階語言(D)視覺化程式語言
《答案》C
33.	在Scratch舞臺上，若角色目前位於舞臺中心且面朝180度方向，執行「移動10點」指令後，角色會移動到哪個方向？(A)左方(B)右方(C)上方(D)下方
《答案》D
34.	在Scratch中，想讓角色利用對話框呈現說話的樣子，如附圖，請問應該使用哪一種類別的積木才能達到目的？(A)音樂類(B)音效類(C)外觀類(D)動作類
《答案》C
35.	執行附圖的程式，角色在舞臺上的運動情形為何？(A)看起來像是停在(0 , 0)位置不動(B)先往左移動，再往右移動(C)先往左下移動，再往右上移動(D)先往左上移動，再往右下移動
《答案》A
36.	小中在Scratch中創造了一個角色X，這個角色含有兩個造型，角色裡含有一段程式。若他把這個角色複製出另外兩個角色Y、Z，則下列敘述何者錯誤？(A)Y中不含程式(B)Y含有兩個造型(C)Y與Z的造型相同(D)X與Z的程式相同
《答案》A
37.	下列關於Scratch程式積木的執行順序，何者符合「循序結構」的概念？(A)積木會根據條件成立與否來決定執行順序(B)積木會根據設定的次數重複執行(C)積木會從最上面一個接一個依序執行到最下面(D)積木的執行順序是隨機的
《答案》C
38.	.使用電腦網路瀏覽器上網時，當瀏覽下列何種網址時，網址列前方會出現附圖的「鎖頭」圖示？(A)ftp://...(B)https://...(C)http://...(D)telnet://...
《答案》B
39.	下列何種情況下，無法只使用一個「如果…那麼…否則…」來進行條件判斷、完成程式？(A)考試成績90分以上為優等；考試成績不到60分為丁等(B)餐廳優惠，5歲以下的兒童免費(C)氣溫達27℃時辦公室才能開啟冷氣，氣溫不到27℃時不能開冷氣(D)單筆消費超過100元可以打九折；單筆消費金額不到100元的可以獲得抽獎券
《答案》A
40.	隨著資訊科技的普及，網路詐騙事件也層出不窮，下列相關態度與看法，何者正確？(A)不要貪小便宜就不會被騙(B)只有笨蛋才會被騙，所以我不會被騙(C)防人之心不可無，應該隨時提高警覺(D)負面案例太多，最好不要使用科技產品與服務
《答案》C
`;

        function parseQuestions(text) {
            const questions = [];
            const regex = /(\d+)\.\s+([\s\S]+?)\s*\(A\)\s*([\s\S]+?)\s*\(B\)\s*([\s\S]+?)\s*\(C\)\s*([\s\S]+?)\s*\(D\)\s*([\s\S]+?)\s*《答案》\s*([A-D])/g;
            let match;
            while ((match = regex.exec(text)) !== null) {
                questions.push({
                    id: match[1],
                    question: match[2].trim(),
                    options: { A: match[3].trim(), B: match[4].trim(), C: match[5].trim(), D: match[6].trim() },
                    answer: match[7].trim()
                });
            }
            return questions;
        }

        function getRandomQuestions(allQuestions, count) {
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
    </script>

    <!-- Start Screen (Compact Layout) -->
    <div id="startScreen" class="absolute inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-md overflow-y-auto py-8 pb-24">
        <div class="cyber-box purple flex flex-col md:flex-row max-w-5xl w-full mx-4 overflow-hidden max-h-[90vh]">
            <!-- Left Panel -->
            <div class="w-full md:w-1/3 p-6 bg-black/50 flex flex-col justify-center border-b md:border-b-0 md:border-r border-gray-700">
                <h1 class="text-4xl font-cyber text-gradient-cyber mb-4 glitch text-center font-bold" data-text="CORE CODE: 資訊獵手">
                    CORE CODE: 資訊獵手
                </h1>
                
                <div class="space-y-4 my-4">
                    <div>
                        <label class="block text-neon-blue mb-1 font-cyber text-sm">CLASS ID (班級)</label>
                        <input type="text" id="inputClass" class="cyber-input w-full p-2 text-lg rounded bg-transparent" placeholder="e.g. 701">
                    </div>
                    <div>
                        <label class="block text-neon-blue mb-1 font-cyber text-sm">SEAT NO. (座號)</label>
                        <input type="text" id="inputSeat" class="cyber-input w-full p-2 text-lg rounded bg-transparent" placeholder="e.g. 01">
                    </div>
                    <div>
                        <label class="block text-neon-blue mb-1 font-cyber text-sm">CODENAME (姓名)</label>
                        <input type="text" id="inputName" class="cyber-input w-full p-2 text-lg rounded bg-transparent" placeholder="YOUR NAME">
                    </div>
                </div>
                
                <button onclick="startGame()" class="cyber-btn mt-4 px-6 py-3 text-lg font-bold rounded w-full">
                    INITIALIZE SYSTEM
                </button>
                <div class="mt-4 text-center text-neon-red text-xs font-bold bg-black/30 p-2 rounded border border-neon-red">
                    ⚠️ 本遊戲僅限電腦版遊玩 (PC/Laptop Only)
                </div>
            </div>

            <!-- Right Panel: Rules -->
            <div class="w-full md:w-2/3 p-6 text-gray-300 overflow-y-auto bg-gray-900/30">
                <h3 class="text-2xl text-neon-green font-bold mb-4 border-b border-gray-700 pb-2">/// MISSION BRIEFING ///</h3>
                <div class="grid grid-cols-1 gap-4 text-sm">
                    <div>
                        <h4 class="text-neon-yellow font-bold mb-1"><i class="fas fa-gamepad"></i> 操作與規則</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-400">
                            <li>操控數據蛇<strong>依序</strong>尋找旗幟 <strong>1 - 25</strong> 進行答題。</li>
                            <li><strong>生命值歸零時，任務失敗，需重新開始！</strong></li>
                            <li><strong>每答對 5 題</strong>，數據蛇的身長會增加。</li>
                            <li><strong>咬到蛇尾</strong> 或 <strong>答錯題目</strong> 會扣除生命值。</li>
                            <li><strong>答對題目</strong> 可微幅回復生命值 (+5%)。</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-neon-blue font-bold mb-1"><i class="fas fa-heartbeat"></i> 道具與獎勵</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-400">
                            <li><strong>紅色數據點：</strong> 獲得基本分數與金幣。</li>
                            <li><strong>數據修復包 (藍色果實)：</strong> 隨機出現，吃到可恢復大量生命值。</li>
                            <li><strong>神秘果實 (金黃閃爍)：</strong> 30秒 <strong>「幽靈模式」</strong> (穿牆)。</li>
                            <li>連勝可獲大量金幣。</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-6 text-xs text-gray-600 text-center">
                    SYSTEM STATUS: ONLINE // GITHUB COMPATIBLE
                </div>
            </div>
        </div>
    </div>

    <!-- Live Leaderboard -->
    <div id="inGameLeaderboard" class="hidden absolute top-48 right-4 w-48 p-2 rounded z-30 flex flex-col gap-1 hidden lg:flex">
        <div class="text-xs text-neon-purple font-cyber border-b border-purple-800 pb-1 mb-1 text-center">LIVE RANKING</div>
        <div id="liveLeaderboardList" class="flex flex-col gap-1">
            <div class="text-center text-gray-500 text-xs">LOADING...</div>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none hidden z-20">
        <div class="cyber-box p-4 min-w-[200px] bg-black/80">
            <div class="text-neon-blue font-cyber text-sm">OPERATOR</div>
            <div id="displayPlayer" class="text-xl font-bold text-white">---</div>
            <div class="mt-2 text-neon-purple font-cyber text-sm">TARGET FLAG</div>
            <div class="text-4xl font-bold text-white flex items-center mt-1">
                <i class="fas fa-flag mr-3 text-neon-purple"></i>
                <span id="displayTarget" class="text-neon-yellow">1</span> <span class="text-xl text-gray-400 ml-2">/ 25</span>
            </div>
        </div>

        <div class="flex flex-col items-center w-1/3">
             <div id="countdownOverlay" class="hidden text-9xl font-cyber text-neon-yellow glitch font-bold drop-shadow-[0_0_15px_rgba(255,255,0,0.8)]" data-text="5">5</div>
             <!-- HP Bar -->
             <div class="w-full max-w-md mt-2 pointer-events-auto">
                 <div class="flex justify-between text-xs font-cyber mb-1">
                     <span class="text-neon-green">SYSTEM INTEGRITY</span>
                     <span id="hpText" class="text-white">100%</span>
                 </div>
                 <div class="hp-bar-container rounded">
                     <div id="hpBar" class="hp-bar-fill" style="width: 100%;"></div>
                 </div>
                 <div id="hpWarning" class="hidden text-neon-red text-center text-sm font-bold mt-1 animate-pulse">WARNING: CRITICAL DAMAGE</div>
             </div>
        </div>

        <div class="cyber-box green p-4 min-w-[200px] text-right bg-black/80">
            <div class="text-neon-green font-cyber text-sm">SCORE</div>
            <div id="displayScore" class="text-4xl font-bold text-white">0000</div>
            <div class="flex justify-end gap-6 mt-2">
                <div>
                    <div class="text-neon-yellow font-cyber text-xs">COINS</div>
                    <div id="displayCoins" class="text-2xl text-white font-bold"><i class="fas fa-coins text-yellow-400"></i> 0</div>
                </div>
                <div>
                    <div class="text-neon-blue font-cyber text-xs">STREAK</div>
                    <div id="displayStreak" class="text-2xl text-white font-bold">x0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer" class="relative hidden">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="absolute inset-0 z-40 hidden items-center justify-center modal-overlay p-4">
        <div class="cyber-box p-6 w-full max-w-4xl bg-black relative flex flex-col quiz-modal-inner shadow-2xl">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2 flex-shrink-0">
                <h2 class="text-2xl font-cyber text-neon-blue truncate">
                    <i class="fas fa-terminal mr-2"></i>DECRYPTION
                </h2>
                <div class="text-right flex-shrink-0">
                    <div class="text-xs text-neon-pink font-cyber">TIME</div>
                    <div id="quizTimer" class="text-4xl font-cyber text-neon-pink">30</div>
                </div>
            </div>
            
            <!-- Question Content -->
            <div id="quizContent" class="hidden flex-1 overflow-y-auto px-1 flex flex-col">
                <!-- Question -->
                <div class="mb-6">
                    <p id="questionText" class="text-lg md:text-xl leading-relaxed font-bold text-white font-sans"></p>
                </div>
                
                <!-- Options (Default View) -->
                <div id="optionsGrid" class="grid grid-cols-1 gap-4 mb-4 p-1">
                    <!-- Options injected here -->
                </div>

                <!-- Result View (Hidden by default, replaces options when answered) -->
                <div id="resultView" class="hidden flex-col items-center justify-center py-8 animate-fade-in">
                    <div id="resultIcon" class="text-8xl mb-4"></div>
                    <div id="resultText" class="text-4xl font-cyber font-bold mb-6"></div>
                    <div id="resultAnswer" class="text-xl text-gray-400 mb-8 font-sans"></div>
                    
                    <button id="continueBtn" onclick="resumeGame()" class="cyber-btn px-12 py-4 w-full md:w-2/3 text-2xl font-bold hover:scale-105 transform transition focus:outline-none focus:ring-4 focus:ring-neon-blue">
                        CONTINUE / 繼續遊戲
                    </button>
                    <div class="text-gray-500 text-sm mt-4">按 Enter 鍵繼續</div>
                </div>
            </div>

            <!-- Pre-Quiz Countdown -->
            <div id="quizCountdown" class="text-center py-20">
                <div class="text-5xl font-cyber text-neon-green mb-4">DECRYPTING...</div>
                <div class="text-7xl font-cyber text-white mb-8" id="preQuizTimer">3</div>
                <div class="loading-bar w-full h-2 bg-gray-800 rounded overflow-hidden">
                    <div class="h-full bg-neon-green w-0 animate-[load_3s_linear_forwards]"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="endScreen" class="absolute inset-0 z-50 hidden flex-col items-center justify-center bg-black/95">
        <div class="cyber-box green p-8 max-w-4xl w-full text-center max-h-[90vh] overflow-y-auto">
            <h1 id="endTitle" class="text-5xl font-cyber text-neon-green mb-4 glitch" data-text="MISSION COMPLETE">MISSION COMPLETE</h1>
            
            <div class="grid grid-cols-4 gap-4 mb-6 mt-4">
                <div class="bg-gray-900/80 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">TOTAL SCORE</div>
                    <div id="endScore" class="text-3xl text-neon-blue font-bold">0</div>
                </div>
                <div class="bg-gray-900/80 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">ACCURACY</div>
                    <div id="endAccuracy" class="text-3xl text-neon-pink font-bold">0%</div>
                </div>
                <div class="bg-gray-900/80 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">COINS</div>
                    <div id="endCoins" class="text-3xl text-neon-yellow font-bold">0</div>
                </div>
                <div class="bg-gray-900/80 p-4 rounded border border-gray-700">
                    <div class="text-gray-400 text-sm mb-1">HP BONUS</div>
                    <div id="endHpBonus" class="text-3xl text-neon-green font-bold">0</div>
                </div>
            </div>

            <div id="rankDisplay" class="text-2xl font-bold mb-4 font-cyber"></div>
            <div id="rankMessage" class="text-xl text-red-400 mb-6 italic font-bold"></div>

            <!-- Leaderboard -->
            <div class="mb-6 bg-black/40 p-4 rounded border border-gray-800">
                <h3 class="text-neon-blue font-cyber mb-2 text-lg">TOP 10 AGENTS</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-gray-500 font-cyber border-b border-gray-700">
                            <tr>
                                <th class="p-2">RANK</th>
                                <th class="p-2">AGENT</th>
                                <th class="p-2">CLASS</th>
                                <th class="p-2">SCORE</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="font-mono text-white">
                            <tr><td colspan="4" class="p-4 text-center">LOADING DATA...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <button onclick="location.reload()" class="cyber-btn px-12 py-3 text-xl font-bold">
                REBOOT SYSTEM
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer id="gameFooter" class="fixed bottom-0 w-full p-4 text-center text-gray-500 text-sm z-50 bg-black/80 backdrop-blur-sm border-t border-gray-800 font-cyber">
        遊戲構思: CLIT Classroom | 國中資訊科技: Final Quiz | 遊戲生成: Gemini
        <a href="https://clitclassroom.github.io/" target="_blank" class="ml-2 text-white hover:text-neon-blue transition-colors">
            <i class="fab fa-github text-lg"></i>
        </a>
    </footer>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            isPlaying: false,
            init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone: function(freq, type, duration, vol=0.1) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playBGM: function() {
                if(this.isPlaying) return;
                this.isPlaying = true;
                if (!this.ctx) this.init();
                const bassNotes = [110, 110, 146, 146, 164, 164, 146, 146];
                const melodyNotes = [440, 0, 440, 493, 523, 493, 440, 392];
                let noteIndex = 0;
                const playStep = () => {
                    if(!this.isPlaying) return;
                    const now = this.ctx.currentTime;
                    const bass = this.ctx.createOscillator();
                    const bassGain = this.ctx.createGain();
                    bass.type = 'triangle';
                    bass.frequency.value = bassNotes[noteIndex % bassNotes.length];
                    bassGain.gain.setValueAtTime(0.05, now);
                    bassGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                    bass.connect(bassGain);
                    bassGain.connect(this.ctx.destination);
                    bass.start();
                    bass.stop(now + 0.2);
                    if(noteIndex % 2 === 0) {
                        const freq = melodyNotes[(noteIndex/2) % melodyNotes.length];
                        if(freq > 0) {
                            const mel = this.ctx.createOscillator();
                            const melGain = this.ctx.createGain();
                            mel.type = 'square';
                            mel.frequency.value = freq;
                            melGain.gain.setValueAtTime(0.02, now);
                            melGain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                            mel.connect(melGain);
                            melGain.connect(this.ctx.destination);
                            mel.start();
                            mel.stop(now + 0.3);
                        }
                    }
                    noteIndex++;
                    setTimeout(playStep, 200);
                };
                playStep();
            },
            stopBGM: function() { this.isPlaying = false; }
        };

        const SFX = {
            hover: () => AudioEngine.playTone(400, 'sine', 0.1),
            select: () => AudioEngine.playTone(800, 'square', 0.1),
            flag: () => { AudioEngine.playTone(1200, 'sine', 0.1); setTimeout(() => AudioEngine.playTone(1800, 'sine', 0.2), 100); },
            correct: () => { AudioEngine.playTone(600, 'sine', 0.1); setTimeout(() => AudioEngine.playTone(900, 'sine', 0.4), 100); },
            wrong: () => { AudioEngine.playTone(150, 'sawtooth', 0.4); setTimeout(() => AudioEngine.playTone(100, 'sawtooth', 0.4), 200); },
            powerup: () => { [400, 500, 600, 800, 1000].forEach((f, i) => setTimeout(() => AudioEngine.playTone(f, 'square', 0.1), i * 50)); },
            ghost: () => { AudioEngine.playTone(200, 'sine', 1.0); AudioEngine.playTone(205, 'sine', 1.0); },
            heal: () => { [400, 600, 800].forEach((f, i) => setTimeout(() => AudioEngine.playTone(f, 'sine', 0.2), i * 100)); } 
        };
    </script>

    <script>
        // --- GAME LOGIC ---
        const GRID_SIZE = 25; 
        const COLS = 32; 
        const ROWS = 24; 
        const TOTAL_FLAGS = 25;
        const BASE_SPEED = 250; 
        const MAX_HP = 100;
        
        let player = { class: '', seat: '', name: '' };
        let gameActive = false;
        let snake = [];
        let direction = { x: 1, y: 0 };
        let nextDirection = { x: 1, y: 0 };
        let currentFlagTarget = 1; 
        let flags = []; 
        let score = 0;
        let coins = 0;
        let streak = 0;
        let hp = MAX_HP;
        let questions = [];
        let items = [];
        let correctCount = 0;
        let ghostMode = false;
        let ghostTimer = 0;
        let ghostInterval;
        let quizTimeInterval;
        let walls = [];
        let quizInputActive = false;
        
        function initGame() {
            const allQuestions = parseQuestions(RAW_PDF_TEXT);
            questions = getRandomQuestions(allQuestions, 25);
            hp = MAX_HP;
            updateHPUI();
            resetSnake();
            generateMap();
            // Initial batch spawn
            for(let i=0; i<5; i++) spawnItem();
            if(window.subscribeLeaderboard) window.subscribeLeaderboard();
        }

        function resetSnake() {
            snake = [{x: 5, y: 5}, {x: 4, y: 5}, {x: 3, y: 5}];
            direction = {x: 1, y: 0};
            nextDirection = {x: 1, y: 0};
        }

        function generateMap() {
            walls = [];
            for(let i=0; i<60; i++) {
                let wx = Math.floor(Math.random() * (COLS - 2)) + 1;
                let wy = Math.floor(Math.random() * (ROWS - 2)) + 1;
                if(wx < 10 && wy < 10) continue;
                walls.push({x: wx, y: wy});
            }

            flags = [];
            for(let i=1; i<=TOTAL_FLAGS; i++) {
                let pos = getValidPosition();
                flags.push({id: i, x: pos.x, y: pos.y, collected: false});
            }
            spawnItem();
        }

        function getValidPosition() {
            let valid = false;
            let pos = {x:0, y:0};
            while(!valid) {
                pos.x = Math.floor(Math.random() * COLS);
                pos.y = Math.floor(Math.random() * ROWS);
                let hitWall = walls.some(w => w.x === pos.x && w.y === pos.y);
                let hitSnake = snake.some(s => s.x === pos.x && s.y === pos.y);
                let hitFlag = flags.some(f => f.x === pos.x && f.y === pos.y);
                let hitItem = items.some(i => i.x === pos.x && i.y === pos.y);
                if(!hitWall && !hitSnake && !hitFlag && !hitItem) valid = true;
            }
            return pos;
        }

        function spawnItem() {
            let pos = getValidPosition();
            // Chance: 50% Food, 25% Heal, 25% Mystery
            let rand = Math.random();
            let type = 'food';
            if(rand > 0.75) type = 'heal';
            else if(rand > 0.5) type = 'mystery';
            
            items.push({x: pos.x, y: pos.y, type: type});
        }

        function checkItemRefill() {
            // Keep at least 3 items on map
            if (items.length < 3) {
                spawnItem();
            }
        }

        function startGame() {
            const c = document.getElementById('inputClass').value;
            const s = document.getElementById('inputSeat').value;
            const n = document.getElementById('inputName').value;

            if(!c || !s || !n) {
                alert("請輸入完整班級、座號與姓名資訊！");
                return;
            }

            player = { class: c, seat: s, name: n };
            document.getElementById('displayPlayer').textContent = `${c}-${s} ${n}`;
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameFooter').classList.add('hidden-footer');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            
            const liveLb = document.getElementById('inGameLeaderboard');
            if(liveLb) liveLb.classList.remove('hidden');

            AudioEngine.playBGM(); 
            initGame();
            startCountdown();
        }

        function startCountdown() {
            const el = document.getElementById('countdownOverlay');
            el.classList.remove('hidden');
            let count = 5;
            el.textContent = count;
            el.dataset.text = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    el.textContent = count;
                    el.dataset.text = count;
                    SFX.select();
                } else {
                    clearInterval(timer);
                    el.textContent = "GO!";
                    el.dataset.text = "GO!";
                    SFX.powerup();
                    setTimeout(() => {
                        el.classList.add('hidden');
                        gameActive = true;
                        gameLoop();
                    }, 1000);
                }
            }, 1000);
        }

        document.addEventListener('keydown', e => {
            if(document.getElementById('quizModal').classList.contains('hidden')) {
                if(!gameActive) return;
                switch(e.key) {
                    case 'ArrowUp': if(direction.y === 0) nextDirection = {x:0, y:-1}; break;
                    case 'ArrowDown': if(direction.y === 0) nextDirection = {x:0, y:1}; break;
                    case 'ArrowLeft': if(direction.x === 0) nextDirection = {x:-1, y:0}; break;
                    case 'ArrowRight': if(direction.x === 0) nextDirection = {x:1, y:0}; break;
                }
            } else {
                handleQuizInput(e);
            }
        });

        // Loop counter for item spawning
        let loopCount = 0;

        function gameLoop() {
            if(!gameActive) return;
            update();
            draw();
            
            // Check item refill every ~2 seconds (approx 12 frames at 160ms)
            loopCount++;
            if(loopCount % 12 === 0) {
                checkItemRefill();
            }

            setTimeout(() => { requestAnimationFrame(gameLoop); }, BASE_SPEED);
        }

        function update() {
            direction = nextDirection;
            const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

            if(head.x < 0) head.x = COLS - 1;
            if(head.x >= COLS) head.x = 0;
            if(head.y < 0) head.y = ROWS - 1;
            if(head.y >= ROWS) head.y = 0;

            if(snake.some(s => s.x === head.x && s.y === head.y)) {
                handleDamage("咬到自己了！");
                resetSnake(); 
                return;
            }

            if(!ghostMode && walls.some(w => w.x === head.x && w.y === head.y)) { return; }

            snake.unshift(head);

            let itemIndex = items.findIndex(i => i.x === head.x && i.y === head.y);
            if(itemIndex !== -1) {
                let item = items[itemIndex];
                items.splice(itemIndex, 1);
                
                if(item.type === 'mystery') { 
                    SFX.powerup();
                    activateGhostMode(); 
                } else if (item.type === 'heal') {
                    SFX.heal();
                    hp = Math.min(MAX_HP, hp + 20); 
                    updateHPUI();
                } else { 
                    SFX.powerup();
                    score += 50; coins += 5; 
                }
                updateHUD();
            }

            let hitFlag = flags.find(f => f.x === head.x && f.y === head.y);
            if(hitFlag) {
                if(hitFlag.id === currentFlagTarget) {
                    SFX.flag();
                    gameActive = false;
                    AudioEngine.stopBGM();
                    startQuiz(hitFlag.id);
                }
            } else {
                // Growth logic here? No, growth is on correct answer.
                // So always pop unless we JUST ate food? 
                // Currently design is: snake size constant unless quiz correct.
                // So always pop here.
                snake.pop(); 
            }
        }

        function handleDamage(reason, amount = 15) {
            hp -= amount;
            updateHPUI();
            streak = 0;
            SFX.wrong();
            updateHUD();
            
            if(hp <= 0) {
                gameOver("SYSTEM FAILURE // 生命值歸零");
            }
        }

        function updateHPUI() {
            const bar = document.getElementById('hpBar');
            const text = document.getElementById('hpText');
            const warn = document.getElementById('hpWarning');
            
            bar.style.width = `${Math.max(0, hp)}%`;
            text.textContent = `${Math.max(0, hp)}%`;
            
            if(hp <= 30) {
                bar.classList.add('hp-critical');
                warn.classList.remove('hidden');
            } else {
                bar.classList.remove('hp-critical');
                warn.classList.add('hidden');
            }
        }

        function activateGhostMode() {
            ghostMode = true;
            SFX.ghost();
            clearTimeout(ghostInterval);
            ghostInterval = setTimeout(() => { ghostMode = false; }, 30000);
            score += 500;
            updateHUD();
        }

        function draw() {
            const cvs = document.getElementById('gameCanvas');
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0, 0, cvs.width, cvs.height);

            ctx.fillStyle = ghostMode ? '#222' : '#1a1a1a';
            ctx.shadowBlur = 0;
            walls.forEach(w => {
                ctx.fillRect(w.x * GRID_SIZE, w.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(w.x * GRID_SIZE, w.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            });

            items.forEach(i => {
                let cx = i.x * GRID_SIZE + GRID_SIZE/2;
                let cy = i.y * GRID_SIZE + GRID_SIZE/2;
                if(i.type === 'mystery') {
                    // Gold Mystery
                    ctx.fillStyle = '#FFD700'; 
                    ctx.shadowColor = '#FFA500'; 
                    ctx.shadowBlur = 25;
                    ctx.beginPath();
                    for(let k=0; k<5; k++){
                        ctx.lineTo(Math.cos((18+k*72)/180*Math.PI)*10 + cx, -Math.sin((18+k*72)/180*Math.PI)*10 + cy);
                        ctx.lineTo(Math.cos((54+k*72)/180*Math.PI)*5 + cx, -Math.sin((54+k*72)/180*Math.PI)*5 + cy);
                    }
                    ctx.fill();
                } else if (i.type === 'heal') {
                    // Blue Heal
                    ctx.fillStyle = '#00f3ff';
                    ctx.shadowColor = '#00f3ff';
                    ctx.shadowBlur = 15;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 7, 0, Math.PI*2);
                    ctx.fill();
                    // Cross symbol
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(cx-2, cy-5, 4, 10);
                    ctx.fillRect(cx-5, cy-2, 10, 4);
                } else {
                    // Red Food
                    ctx.fillStyle = '#ff3333';
                    ctx.shadowColor = '#ff0000';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 6, 0, Math.PI*2);
                    ctx.fill();
                }
            });

            flags.forEach(f => {
                if(f.collected) return;
                let isTarget = f.id === currentFlagTarget;
                ctx.shadowBlur = isTarget ? 15 : 0;
                ctx.shadowColor = isTarget ? '#bd00ff' : 'transparent';
                ctx.fillStyle = isTarget ? '#bd00ff' : '#555';
                ctx.fillRect(f.x * GRID_SIZE + 2, f.y * GRID_SIZE + 2, 4, 20); 
                ctx.fillRect(f.x * GRID_SIZE + 6, f.y * GRID_SIZE + 2, 16, 12); 
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.fillText(f.id, f.x * GRID_SIZE + 8, f.y * GRID_SIZE + 13);
            });

            snake.forEach((s, i) => {
                let color = ghostMode ? `hsl(${Date.now() % 360}, 100%, 50%)` : '#0f0';
                if(i === 0) color = '#fff';
                ctx.fillStyle = color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = color;
                if(ghostMode) ctx.globalAlpha = 0.6;
                ctx.fillRect(s.x * GRID_SIZE + 1, s.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2);
                ctx.globalAlpha = 1.0;
            });
        }

        // --- QUIZ LOGIC ---
        let quizSelection = 0; 

        function startQuiz(flagId) {
            quizInputActive = false; 
            const modal = document.getElementById('quizModal');
            const content = document.getElementById('quizContent');
            const countdown = document.getElementById('quizCountdown');
            const preQuizTimer = document.getElementById('preQuizTimer');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset Views
            content.classList.add('hidden');
            document.getElementById('optionsGrid').classList.remove('hidden');
            document.getElementById('resultView').classList.add('hidden');
            document.getElementById('resultView').classList.remove('flex');
            
            countdown.classList.remove('hidden');
            
            let count = 3;
            preQuizTimer.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    preQuizTimer.textContent = count;
                    SFX.select();
                } else {
                    clearInterval(timer);
                    countdown.classList.add('hidden');
                    content.classList.remove('hidden');
                    showQuestion();
                }
            }, 1000);
        }

        function showQuestion() {
            quizInputActive = true; 
            // Fix: Use currentFlagTarget - 1 to get correct index
            let qIndex = currentFlagTarget - 1;
            // The questions array is only 25 items long, so index 0-24. 
            // currentFlagTarget goes from 1 to 25.
            // If currentFlagTarget is 1, index is 0. 
            // Logic is sound, but we must ensure questions array has correct data.
            
            const q = questions[qIndex];
            // Safety check in case q is undefined
            if (!q) {
                console.error("Question not found for index:", qIndex);
                resumeGame();
                return;
            }

            document.getElementById('questionText').textContent = `Q${currentFlagTarget}. ${q.question}`;
            
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            quizSelection = -1;

            ['A', 'B', 'C', 'D'].forEach((key, idx) => {
                const btn = document.createElement('div');
                btn.className = 'answer-option border border-cyan-500 p-3 rounded text-left text-lg relative cursor-pointer';
                btn.innerHTML = `<span class="text-neon-purple font-bold mr-3 text-xl">${key}.</span> ${q.options[key]}`;
                btn.dataset.idx = idx;
                btn.dataset.key = key;
                btn.onclick = () => confirmAnswer(key);
                btn.onmouseenter = () => {
                    if(!quizInputActive) return;
                    quizSelection = idx;
                    updateQuizSelection();
                    SFX.hover();
                };
                grid.appendChild(btn);
            });
            
            // Fix: Ensure feedback area scrolls into view when shown
            const quizModalInner = document.querySelector('.quiz-modal-inner');
            if(quizModalInner) quizModalInner.scrollTop = 0; 

            const qTimer = document.getElementById('quizTimer');
            let timeLeft = 30; 
            qTimer.textContent = timeLeft;
            
            if(quizTimeInterval) clearInterval(quizTimeInterval);
            
            quizTimeInterval = setInterval(() => {
                timeLeft--;
                qTimer.textContent = timeLeft < 10 ? `0${timeLeft}` : timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(quizTimeInterval);
                    handleAnswerTimeout();
                }
            }, 1000);
        }

        function updateQuizSelection() {
            const opts = document.getElementById('optionsGrid').children;
            for(let i=0; i<opts.length; i++) {
                if(i === quizSelection) opts[i].classList.add('selected', 'bg-cyan-900');
                else opts[i].classList.remove('selected', 'bg-cyan-900');
            }
        }

        let inputDebounce = false;
        function handleQuizInput(e) {
            // If result view is visible, Enter resumes game
            if(!document.getElementById('resultView').classList.contains('hidden')) {
                if(e.key === 'Enter') {
                    resumeGame();
                }
                return;
            }

            if(!quizInputActive || inputDebounce) return;

            inputDebounce = true;
            setTimeout(() => inputDebounce = false, 100);

            if(e.key === 'ArrowUp') {
                quizSelection--;
                if(quizSelection < 0) quizSelection = 3;
                SFX.hover();
                updateQuizSelection();
            } else if(e.key === 'ArrowDown') {
                quizSelection++;
                if(quizSelection > 3) quizSelection = 0;
                SFX.hover();
                updateQuizSelection();
            } else if(e.key === 'Enter') {
                if(quizSelection !== -1) {
                    const key = ['A','B','C','D'][quizSelection];
                    confirmAnswer(key);
                }
            }
        }

        function handleAnswerTimeout() {
            showResult(false, true);
        }

        function confirmAnswer(selected) {
            if(!quizInputActive) return;
            clearInterval(quizTimeInterval);
            quizInputActive = false; 

            let qIndex = currentFlagTarget - 1;
            const q = questions[qIndex];
            const correct = q.answer;
            const isCorrect = (selected === correct);

            showResult(isCorrect, false, correct);
        }

        function showResult(isCorrect, isTimeout, correctAnswerKey) {
            // Hide Options, Show Result
            document.getElementById('optionsGrid').classList.add('hidden');
            const resultView = document.getElementById('resultView');
            resultView.classList.remove('hidden');
            resultView.classList.add('flex');

            const icon = document.getElementById('resultIcon');
            const text = document.getElementById('resultText');
            const ansText = document.getElementById('resultAnswer');
            const btn = document.getElementById('continueBtn');

            // Logic updates
            if(isTimeout) {
                SFX.wrong();
                icon.innerHTML = '<i class="fas fa-hourglass-end text-neon-red"></i>';
                text.textContent = "TIME OUT";
                text.className = "text-4xl font-cyber font-bold mb-4 text-neon-red";
                ansText.textContent = `正確答案: ${questions[currentFlagTarget-1].answer}`;
                handleDamage("作答超時！", 20);
            } else if(isCorrect) {
                SFX.correct();
                icon.innerHTML = '<i class="fas fa-check-circle text-neon-green"></i>';
                text.textContent = "CORRECT";
                text.className = "text-4xl font-cyber font-bold mb-4 text-neon-green";
                ansText.textContent = "系統代碼解析成功";
                
                score += 100;
                correctCount++;
                streak++;
                
                // Heal on correct
                hp = Math.min(MAX_HP, hp + 5);
                updateHPUI();

                if([3, 5, 10, 15, 20].includes(streak)) { score += streak * 50; }
                coins += 50 + (streak * 10); 
                // Growth: every 5 correct answers
                if(correctCount % 5 === 0) { 
                    snake.push({...snake[snake.length-1]}); 
                }
            } else {
                SFX.wrong();
                icon.innerHTML = '<i class="fas fa-times-circle text-neon-red"></i>';
                text.textContent = "WRONG";
                text.className = "text-4xl font-cyber font-bold mb-4 text-neon-red";
                ansText.textContent = `正確答案: ${correctAnswerKey}`;
                handleDamage("答錯了！", 20);
            }

            btn.classList.remove('hidden');
            // Auto focus for immediate Enter key press
            setTimeout(() => btn.focus(), 100);
            updateHUD();
        }

        function resumeGame() {
            // If HP <= 0, game over handles transition
            if(hp <= 0) return;

            document.getElementById('quizModal').classList.add('hidden');
            document.getElementById('quizModal').classList.remove('flex');
            quizInputActive = false;
            
            let f = flags.find(flag => flag.id === currentFlagTarget);
            if(f) f.collected = true;
            
            currentFlagTarget++;
            // Fix: ensure display stays in bounds
            document.getElementById('displayTarget').textContent = currentFlagTarget <= 25 ? currentFlagTarget : 25;

            // Spawn new items on resume to keep map busy
            spawnItem();

            if(currentFlagTarget > 25) {
                endGame(true); 
            } else {
                gameActive = true;
                AudioEngine.playBGM();
                gameLoop();
            }
        }

        function updateHUD() {
            document.getElementById('displayScore').textContent = score;
            document.getElementById('displayCoins').innerHTML = `<i class="fas fa-coins text-yellow-400"></i> ${coins}`;
            document.getElementById('displayStreak').textContent = `x${streak}`;
        }

        function gameOver(reason) {
            gameActive = false;
            AudioEngine.stopBGM();
            SFX.wrong(); 
            
            document.getElementById('quizModal').classList.add('hidden'); 
            document.getElementById('quizModal').classList.remove('flex');

            showEndScreen(false, reason);
        }

        function endGame(victory) {
            gameActive = false;
            AudioEngine.stopBGM();
            if(victory) SFX.powerup(); 
            showEndScreen(victory, "MISSION COMPLETE");
        }

        function showEndScreen(victory, title) {
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('inGameLeaderboard').classList.add('hidden'); 
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('endScreen').classList.add('flex');
            document.getElementById('gameFooter').classList.remove('hidden-footer');

            const titleEl = document.getElementById('endTitle');
            titleEl.textContent = title;
            titleEl.className = victory ? "text-5xl font-cyber text-neon-green mb-4 glitch" : "text-5xl font-cyber text-neon-red mb-4 glitch";
            titleEl.setAttribute('data-text', title);

            let hpBonus = victory ? hp * 10 : 0;
            let finalScore = score + hpBonus;

            // Updated Accuracy Calculation: (Correct Count / 25) * 100
            const acc = Math.round((correctCount / 25) * 100);
            document.getElementById('endScore').textContent = finalScore;
            document.getElementById('endAccuracy').textContent = `${acc}%`;
            document.getElementById('endCoins').textContent = coins;
            document.getElementById('endHpBonus').textContent = hpBonus;

            let rank = "ROOKIE (菜鳥)";
            let rankClass = "text-gray-400";
            
            if (!victory) {
                rank = "MISSION FAILED";
                rankClass = "text-neon-red";
            } else {
                if(finalScore >= 6000) { rank = "CYBER LEGEND (傳奇)"; rankClass = "text-neon-yellow"; }
                else if(finalScore >= 4500) { rank = "ELITE HACKER (菁英)"; rankClass = "text-neon-purple"; }
                else if(finalScore >= 3000) { rank = "SENIOR AGENT (資深)"; rankClass = "text-neon-green"; }
                else { rank = "OPERATOR (操作員)"; rankClass = "text-neon-blue"; }
            }
            
            const rDisplay = document.getElementById('rankDisplay');
            rDisplay.textContent = rank;
            rDisplay.className = `text-5xl font-bold mb-4 font-cyber ${rankClass} glitch`;
            rDisplay.dataset.text = rank;

            const msg = document.getElementById('rankMessage');
            if (!victory) {
                msg.textContent = "警告：生命值歸零，請重新接受訓練！";
            } else if(finalScore < 3000 || acc < 60) {
                msg.textContent = "⚠️ 警告：核心數據同步率過低。請熟讀期末考題庫內容再來挑戰。";
            } else {
                msg.textContent = "SYSTEM SYNC COMPLETE. 任務圓滿達成！";
            }

            const playerData = {
                name: player.name,
                class: player.class,
                seat: player.seat,
                score: finalScore,
                accuracy: acc,
                coins: coins
            };
            window.saveScore(playerData);
            window.subscribeLeaderboard(window.updateLeaderboards);
        }
    </script>
    
    <style>
        @keyframes load { 0% { width: 0; } 100% { width: 100%; } }
        @keyframes fade-in { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</body>

</html>


