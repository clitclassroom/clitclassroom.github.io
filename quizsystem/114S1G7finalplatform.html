<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上測驗平台 | CLIT Classroom</title>
    
    <!-- ★★★ 網站小圖示 (Favicon) ★★★ -->
    <link rel="icon" href="img/favicon.png" type="image/png">
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 設定 Tailwind 主題 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a' },
                        cyan: { 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2' },
                    },
                    // 新增自定義動畫關鍵影格
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }, // 向上漂浮 10px
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite', // 設定懸浮動畫時間與頻率
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* 玻璃擬態背景 */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased selection:bg-cyan-500/30 selection:text-cyan-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 ---
        const Icons = {
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            XCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Loader2: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Award: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            ImageOff: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M21 21l-2.5-2.5"/><path d="M5 21l-3-3L17 3l4.5 4.5"/><path d="M9 13l2 2 4-4"/></svg>,
            Github: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
        };

        // --- 設定區 ---
        const DEFAULT_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQv69ghgypSFuSUegINZCKLmPOoWSoozCttkBs4MQGO-vtV6NALNZvkgvnMrjgKqoXz3N15uG8Qorn3/pub?output=csv";
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrcJCtzRHfXod3WzYQ5D0U5SGdjmxPLyqhqQoCZ3fFawphzz2F9dfG9swL9sMkvKTz/exec";

        // --- 元件: Footer ---
        const Footer = () => (
            <footer className="mt-12 text-center pb-8 border-t border-slate-800 pt-8 w-full max-w-2xl mx-auto">
                <div className="flex flex-col items-center justify-center gap-1">
                    <p className="text-slate-400 text-sm font-medium tracking-wide">
                        © 2025 CLIT Classroom | 國中資訊科技
                    </p>
                    <div className="flex items-center justify-center gap-3">
                        <p className="text-slate-600 text-xs uppercase tracking-wider">
                            Content: Quiz System
                        </p>
                        <a 
                            href="https://clitclassroom.github.io/" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-slate-500 hover:text-cyan-400 transition-all duration-300 hover:scale-125 pb-0.5"
                            aria-label="GitHub Link"
                        >
                            <Icons.Github />
                        </a>
                    </div>
                </div>
            </footer>
        );

        // --- 元件: QuizImage ---
        const QuizImage = ({ url }) => {
            const [imgSrc, setImgSrc] = useState(url);
            const [isError, setIsError] = useState(false);
            const [retryCount, setRetryCount] = useState(0);

            const getDriveId = (link) => {
                const match = link.match(/\/d\/(.*?)\/|\?id=(.*?)(&|$)/);
                return match ? (match[1] || match[2]) : null;
            };

            const handleError = () => {
                const driveId = getDriveId(url);
                if (retryCount === 0 && driveId) {
                    setImgSrc(`https://drive.google.com/thumbnail?id=${driveId}&sz=w1000`);
                    setRetryCount(1);
                } else {
                    setIsError(true);
                }
            };

            if (isError) {
                return (
                    <div className="w-full p-6 bg-slate-800/50 border border-dashed border-slate-700 rounded-xl flex flex-col items-center justify-center gap-2 text-slate-400 mb-6">
                        <Icons.ImageOff />
                        <p className="text-sm font-medium">圖片預覽載入失敗</p>
                        <a href={url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-cyan-400 hover:text-cyan-300 hover:underline text-xs font-bold mt-1">
                            <Icons.ExternalLink />
                            開啟外部連結
                        </a>
                    </div>
                );
            }

            return (
                <div className="mb-6 rounded-xl overflow-hidden border border-slate-700 bg-slate-800/50 relative min-h-[200px] flex items-center justify-center group">
                    <img 
                        src={imgSrc} 
                        alt="Question Reference" 
                        className="w-full h-auto max-h-[500px] object-contain mx-auto transition-transform duration-500 group-hover:scale-[1.02]"
                        referrerPolicy="no-referrer"
                        onError={handleError}
                    />
                </div>
            );
        };

        // --- Main App Component ---
        function App() {
            const [appState, setAppState] = useState('SETUP');
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [showAnswer, setShowAnswer] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [userInfo, setUserInfo] = useState({ className: '', seatNumber: '', name: '' });
            
            const [sheetUrl, setSheetUrl] = useState(DEFAULT_SHEET_URL);
            const [scriptUrl, setScriptUrl] = useState(DEFAULT_SCRIPT_URL);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitStatus, setSubmitStatus] = useState('IDLE');

            const shuffleArray = (array) => {
                const newArr = [...array];
                for (let i = newArr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
                }
                return newArr;
            };

            const convertToGoogleDriveDirectLink = (url) => {
                if (!url) return url;
                let cleanUrl = url.replace(/{|}/g, '').trim();
                if (cleanUrl.includes('drive.google.com')) {
                    const idMatch = cleanUrl.match(/\/d\/(.*?)\/|\?id=(.*?)(&|$)/);
                    if (idMatch) {
                        const id = idMatch[1] || idMatch[2];
                        if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
                    }
                }
                return cleanUrl;
            };

            const parseCSV = (csvText) => {
                const lines = csvText.split('\n');
                const result = [];
                const headerLine = lines[0].trim().replace(/^\uFEFF/, '');
                const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
                
                let idxId = 0, idxQuestion = 1, idxA = 2, idxB = 3, idxC = 4, idxD = 5, idxAns = 6, idxNeedImage = 7, idxImgUrl = 9;

                headers.forEach((h, index) => {
                    if (h.includes('圖檔url') || h.includes('連結')) idxImgUrl = index;
                });

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    let finalParts = parts;
                    if (parts.length < idxAns) finalParts = line.split(',');
                    const cleanParts = finalParts.map(p => p.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

                    if (cleanParts.length > idxAns) {
                        const needImageVal = cleanParts[idxNeedImage]?.trim();
                        const needImage = needImageVal === '1' || needImageVal === 'TRUE' || needImageVal === 'true';
                        let imgUrl = cleanParts[idxImgUrl];
                        if (imgUrl) imgUrl = convertToGoogleDriveDirectLink(imgUrl);
                        const finalImageUrl = (needImage && imgUrl && imgUrl.length > 5) ? imgUrl : undefined;

                        result.push({
                            id: cleanParts[idxId] || i.toString(),
                            question: cleanParts[idxQuestion],
                            options: { A: cleanParts[idxA], B: cleanParts[idxB], C: cleanParts[idxC], D: cleanParts[idxD] },
                            correctAnswer: cleanParts[idxAns]?.toUpperCase() || "",
                            imageUrl: finalImageUrl
                        });
                    }
                }
                return result;
            };

            const startProcess = async () => {
                if (!userInfo.className || !userInfo.seatNumber || !userInfo.name) {
                    setErrorMsg("請完整填寫班級、座號與姓名");
                    return;
                }
                setAppState('LOADING');
                setErrorMsg('');
                try {
                    const response = await fetch(sheetUrl);
                    if (!response.ok) throw new Error("無法讀取題庫，請確認連結權限");
                    const text = await response.text();
                    const allQuestions = parseCSV(text);
                    if (allQuestions.length === 0) throw new Error("讀取不到題目");
                    const shuffled = shuffleArray(allQuestions);
                    setQuestions(shuffled.slice(0, 25));
                    setCurrentQIndex(0);
                    setScore(0);
                    setShowAnswer(false);
                    setSelectedOption(null);
                    setSubmitStatus('IDLE');
                    setAppState('QUIZ');
                } catch (err) {
                    setErrorMsg(err.message || "讀取發生錯誤");
                    setAppState('SETUP');
                }
            };

            const handleOptionClick = (key) => { if (!showAnswer) setSelectedOption(key); };
            const handleSubmitAnswer = () => {
                if (!selectedOption) return;
                if (selectedOption === questions[currentQIndex].correctAnswer) setScore(s => s + 1);
                setShowAnswer(true);
            };
            const handleNextQuestion = () => {
                if (currentQIndex + 1 < questions.length) {
                    setCurrentQIndex(p => p + 1);
                    setSelectedOption(null);
                    setShowAnswer(false);
                } else {
                    setAppState('RESULT');
                }
            };

            const submitScoreToSheet = async () => {
                if (!scriptUrl) return setErrorMsg("未設定儲存連結");
                setIsSubmitting(true);
                try {
                    const data = {
                        className: userInfo.className,
                        seatNumber: userInfo.seatNumber,
                        name: userInfo.name,
                        score: score * 4,
                        correctCount: score,
                        total: questions.length,
                        accuracy: Math.round((score / questions.length) * 100) + '%'
                    };
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    setSubmitStatus('SUCCESS');
                } catch (e) {
                    setSubmitStatus('ERROR');
                } finally {
                    setIsSubmitting(false);
                }
            };

            // --- Views ---
            
            // 1. 設定畫面
            if (appState === 'SETUP') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                        <div className="glass-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative border-t border-slate-700/50">
                            {/* 頂部裝飾 */}
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-cyan-400 to-blue-500"></div>
                            
                            <div className="p-8 text-center border-b border-slate-700/50 relative overflow-hidden">
                                <div className="relative z-10">
                                    {/* 這裡加入 animate-float 動畫 */}
                                    <div className="text-cyan-400 mx-auto mb-4 flex justify-center drop-shadow-[0_0_15px_rgba(34,211,238,0.5)] animate-float">
                                        <Icons.BookOpen />
                                    </div>
                                    <h1 className="text-2xl font-bold text-white tracking-tight">線上測驗系統</h1>
                                    <p className="text-cyan-300/80 text-sm mt-1 font-medium tracking-wide">範圍:114上七年級資訊科技</p>
                                    <p className="text-slate-400 text-sm mt-4 font-light">請輸入個人資料以開始測驗</p>
                                </div>
                                {/* 背景光暈 */}
                                <div className="absolute top-[-50%] left-1/2 -translate-x-1/2 w-32 h-32 bg-cyan-500/20 rounded-full blur-3xl"></div>
                            </div>
                            
                            <div className="p-8 space-y-5">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1">班級 Class</label>
                                        <input 
                                            type="text" 
                                            className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-slate-200 focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all placeholder:text-slate-600" 
                                            placeholder="例如：701" 
                                            value={userInfo.className} 
                                            onChange={e => setUserInfo({...userInfo, className: e.target.value})} 
                                        />
                                    </div>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1">座號 No.</label>
                                            <input 
                                                type="text" 
                                                className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-slate-200 focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all placeholder:text-slate-600" 
                                                placeholder="01" 
                                                value={userInfo.seatNumber} 
                                                onChange={e => setUserInfo({...userInfo, seatNumber: e.target.value})} 
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 ml-1">姓名 Name</label>
                                            <input 
                                                type="text" 
                                                className="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-slate-200 focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all placeholder:text-slate-600" 
                                                placeholder="王小明" 
                                                value={userInfo.name} 
                                                onChange={e => setUserInfo({...userInfo, name: e.target.value})} 
                                            />
                                        </div>
                                    </div>
                                </div>
                                {errorMsg && (
                                    <div className="flex items-center gap-2 text-red-400 bg-red-900/20 border border-red-900/50 p-3 rounded-xl text-sm animate-pulse">
                                        <Icons.AlertCircle />{errorMsg}
                                    </div>
                                )}
                                <button 
                                    onClick={startProcess} 
                                    className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 mt-2 shadow-lg shadow-cyan-900/20 transition-all hover:scale-[1.02] active:scale-95"
                                >
                                    <Icons.Play />
                                    <span className="tracking-wide">開始測驗 START</span>
                                </button>
                            </div>
                        </div>
                        <Footer />
                    </div>
                );
            }

            // 2. 載入中
            if (appState === 'LOADING') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900">
                        <div className="text-center relative">
                            <div className="animate-spin text-cyan-400 mx-auto mb-6 flex justify-center drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">
                                <Icons.Loader2 />
                            </div>
                            <p className="text-slate-300 font-medium tracking-wide animate-pulse">
                                資料讀取中 / Loading...
                            </p>
                            <p className="text-slate-500 text-sm mt-2">正在從雲端題庫隨機抽取 25 題</p>
                        </div>
                    </div>
                );
            }

            // 3. 測驗進行中
            if (appState === 'QUIZ') {
                const currentQ = questions[currentQIndex];
                const progress = ((currentQIndex + 1) / questions.length) * 100;
                // 計算即時分數顯示
                const currentPoints = score * 4;
                
                return (
                    <div className="min-h-screen bg-slate-900 py-8 px-4 flex flex-col items-center font-sans">
                        <div className="w-full max-w-2xl flex flex-col h-full">
                            {/* Header Info */}
                            <div className="flex justify-between items-end mb-4 px-2">
                                <div>
                                    <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Candidate</p>
                                    <div className="flex items-center gap-2 text-slate-200 font-medium bg-slate-800/50 px-3 py-1 rounded-lg border border-slate-700">
                                        <span className="text-cyan-400">{userInfo.className}</span>
                                        <span className="w-px h-3 bg-slate-600"></span>
                                        <span>{userInfo.seatNumber}</span>
                                        <span className="w-px h-3 bg-slate-600"></span>
                                        <span>{userInfo.name}</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Current Points</p>
                                    <span className="text-2xl font-mono font-bold text-cyan-400 drop-shadow-[0_0_8px_rgba(34,211,238,0.3)]">
                                        {currentPoints.toString().padStart(3, '0')}
                                    </span>
                                </div>
                            </div>

                            {/* Progress Bar */}
                            <div className="bg-slate-800 h-1.5 w-full rounded-full mb-6 overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(34,211,238,0.5)]" 
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>

                            {/* Question Card */}
                            <div className="glass-card rounded-2xl shadow-2xl overflow-hidden flex-grow flex flex-col border border-slate-700/50">
                                <div className="p-6 md:p-8 border-b border-slate-700/50 bg-slate-800/30">
                                    <div className="flex items-center justify-between mb-4">
                                        <span className="inline-block px-3 py-1 bg-blue-900/30 text-blue-300 border border-blue-500/30 text-xs font-bold rounded-full tracking-wide">
                                            QUESTION {currentQIndex + 1} <span className="text-slate-500 mx-1">/</span> {questions.length}
                                        </span>
                                    </div>
                                    
                                    {currentQ.imageUrl && <QuizImage url={currentQ.imageUrl} />}
                                    
                                    <h2 className="text-xl md:text-2xl font-bold text-slate-100 leading-relaxed whitespace-pre-wrap tracking-wide">
                                        {currentQ.question}
                                    </h2>
                                </div>

                                <div className="p-6 md:p-8 space-y-3 bg-slate-900/20 flex-grow">
                                    {Object.entries(currentQ.options).map(([key, value]) => {
                                        let btnClass = "w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between group relative overflow-hidden ";
                                        if (showAnswer) {
                                            if (key === currentQ.correctAnswer) btnClass += "border-green-500/50 bg-green-900/20 text-green-300";
                                            else if (key === selectedOption) btnClass += "border-red-500/50 bg-red-900/20 text-red-300";
                                            else btnClass += "border-slate-800 bg-slate-800/50 text-slate-500 opacity-50";
                                        } else {
                                            if (selectedOption === key) btnClass += "border-cyan-500 bg-cyan-900/20 text-cyan-300 shadow-[0_0_15px_rgba(6,182,212,0.15)] scale-[1.01]";
                                            else btnClass += "border-slate-700/50 bg-slate-800/40 text-slate-300 hover:border-slate-500 hover:bg-slate-800 hover:text-white";
                                        }
                                        return (
                                            <button key={key} onClick={() => handleOptionClick(key)} disabled={showAnswer} className={btnClass}>
                                                <div className="flex items-center gap-4 relative z-10">
                                                    <span className={`w-8 h-8 flex flex-shrink-0 items-center justify-center rounded-lg text-sm font-bold border transition-colors ${
                                                        selectedOption === key || (showAnswer && key === currentQ.correctAnswer) ? "border-current bg-current/10" : "border-slate-600 text-slate-500 group-hover:border-slate-400 group-hover:text-slate-300"
                                                    }`}>{key}</span>
                                                    <span className="text-base font-medium">{value}</span>
                                                </div>
                                                {showAnswer && key === currentQ.correctAnswer && <div className="text-green-400"><Icons.CheckCircle /></div>}
                                                {showAnswer && key === selectedOption && key !== currentQ.correctAnswer && <div className="text-red-400"><Icons.XCircle /></div>}
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="p-6 bg-slate-800/50 border-t border-slate-700/50 flex justify-end backdrop-blur-sm">
                                    {!showAnswer ? (
                                        <button 
                                            onClick={handleSubmitAnswer} 
                                            disabled={!selectedOption} 
                                            className={`px-8 py-3 rounded-xl font-bold transition-all shadow-lg ${
                                                selectedOption 
                                                ? "bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:shadow-cyan-500/25 hover:scale-105" 
                                                : "bg-slate-800 text-slate-600 cursor-not-allowed border border-slate-700"
                                            }`}
                                        >
                                            確認答案 Confirm
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={handleNextQuestion} 
                                            className="px-8 py-3 bg-slate-100 hover:bg-white text-slate-900 rounded-xl font-bold shadow-lg shadow-white/5 hover:scale-105 transition-all flex items-center gap-2"
                                        >
                                            {currentQIndex + 1 === questions.length ? "查看成績 Finish" : "下一題 Next"} <Icons.Play />
                                        </button>
                                    )}
                                </div>
                            </div>
                            
                            <Footer />
                        </div>
                    </div>
                );
            }

            // 4. 結果畫面
            if (appState === 'RESULT') {
                const percentage = Math.round((score / questions.length) * 100);
                // 計算總分
                const finalScore = score * 4;
                
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                        <div className="glass-card w-full max-w-md rounded-3xl shadow-2xl overflow-hidden relative border border-slate-700/50">
                            <div className="bg-slate-800/80 p-10 pb-16 text-center relative overflow-hidden">
                                <div className="relative z-10">
                                    <h2 className="text-3xl font-bold text-white mb-2 tracking-tight">測驗結束</h2>
                                    <p className="text-slate-400 text-sm font-medium">COMPLETED</p>
                                    <div className="mt-4 inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-slate-900/50 border border-slate-700 text-slate-300 text-sm">
                                        <span className="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
                                        {userInfo.className} {userInfo.name}
                                    </div>
                                </div>
                                {/* 裝飾光 */}
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-500/20 rounded-full blur-[80px]"></div>
                            </div>
                            
                            <div className="relative -mt-10 px-6 pb-8">
                                <div className="bg-slate-900/90 rounded-2xl shadow-xl p-8 mb-6 border border-slate-700 backdrop-blur-xl text-center">
                                   <div className="w-20 h-20 bg-gradient-to-br from-yellow-400 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg shadow-amber-500/20">
                                      <Icons.Award />
                                   </div>
                                   <div className="text-6xl font-black text-white mb-2 tracking-tight font-mono">
                                     {finalScore}<span className="text-2xl text-slate-500 font-medium font-sans ml-1">分</span>
                                   </div>
                                   <div className="text-cyan-400 font-bold tracking-wider text-sm uppercase mb-2">答對 {score} / {questions.length} 題</div>
                                   <div className="text-slate-500 text-xs">Accuracy {percentage}%</div>
                                </div>

                                <div className="space-y-3">
                                    {submitStatus === 'IDLE' && (
                                        <button 
                                            onClick={submitScoreToSheet} 
                                            disabled={isSubmitting} 
                                            className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2 group hover:scale-[1.02]"
                                        >
                                            {isSubmitting ? <div className="animate-spin"><Icons.Loader2 /></div> : <div className="group-hover:scale-110 transition-transform"><Icons.Save /></div>} 
                                            儲存成績到雲端
                                        </button>
                                    )}
                                    
                                    {submitStatus === 'SUCCESS' && (
                                        <div className="w-full bg-emerald-900/30 text-emerald-400 py-3.5 rounded-xl flex items-center justify-center gap-2 font-bold border border-emerald-500/30">
                                            <Icons.CheckCircle /> 成績已上傳成功
                                        </div>
                                    )}
                                    
                                    {submitStatus === 'ERROR' && (
                                        <button onClick={submitScoreToSheet} className="w-full bg-red-900/30 text-red-400 hover:bg-red-900/50 py-3.5 rounded-xl flex items-center justify-center gap-2 font-bold border border-red-500/30 transition-colors">
                                            <Icons.AlertCircle /> 上傳失敗，點此重試
                                        </button>
                                    )}

                                    <button 
                                        onClick={() => setAppState('SETUP')} 
                                        className="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3.5 rounded-xl transition-colors border border-slate-700"
                                    >
                                        回到首頁 (新測驗)
                                    </button>
                                </div>
                            </div>
                        </div>
                        <Footer />
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
